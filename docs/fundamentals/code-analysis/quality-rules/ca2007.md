---
title: 'CA2007: タスクを直接待機しない (コード分析)'
description: 'コード分析規則「CA2007: タスクを直接待機しない」について'
ms.date: 03/08/2019
ms.topic: reference
f1_keywords:
- CA2007
- DoNotDirectlyAwaitATaskAnalyzer
helpviewer_keywords:
- CA2007
author: gewarren
ms.author: gewarren
dev_langs:
- CSharp
ms.openlocfilehash: 9a1e21c75a24357744046ccbf8215fd5364ebfc2
ms.sourcegitcommit: 05d0087dfca85aac9ca2960f86c5efd218bf833f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/30/2021
ms.locfileid: "99754772"
---
# <a name="ca2007-do-not-directly-await-a-task"></a><span data-ttu-id="dba0a-103">CA2007:タスクを直接待機しないでください</span><span class="sxs-lookup"><span data-stu-id="dba0a-103">CA2007: Do not directly await a Task</span></span>

| | <span data-ttu-id="dba0a-104">値</span><span class="sxs-lookup"><span data-stu-id="dba0a-104">Value</span></span> |
|-|-|
| <span data-ttu-id="dba0a-105">**ルール ID**</span><span class="sxs-lookup"><span data-stu-id="dba0a-105">**Rule ID**</span></span> |<span data-ttu-id="dba0a-106">CA2007</span><span class="sxs-lookup"><span data-stu-id="dba0a-106">CA2007</span></span>|
| <span data-ttu-id="dba0a-107">**カテゴリ**</span><span class="sxs-lookup"><span data-stu-id="dba0a-107">**Category**</span></span> |[<span data-ttu-id="dba0a-108">信頼性</span><span class="sxs-lookup"><span data-stu-id="dba0a-108">Reliability</span></span>](reliability-warnings.md)|
| <span data-ttu-id="dba0a-109">**修正が中断か中断なしであるか**</span><span class="sxs-lookup"><span data-stu-id="dba0a-109">**Fix is breaking or non-breaking**</span></span> |<span data-ttu-id="dba0a-110">なし</span><span class="sxs-lookup"><span data-stu-id="dba0a-110">Non-breaking</span></span>|

## <a name="cause"></a><span data-ttu-id="dba0a-111">原因</span><span class="sxs-lookup"><span data-stu-id="dba0a-111">Cause</span></span>

<span data-ttu-id="dba0a-112">非同期メソッドでは <xref:System.Threading.Tasks.Task> を直接[待機](../../../csharp/language-reference/operators/await.md)します。</span><span class="sxs-lookup"><span data-stu-id="dba0a-112">An asynchronous method [awaits](../../../csharp/language-reference/operators/await.md) a <xref:System.Threading.Tasks.Task> directly.</span></span>

## <a name="rule-description"></a><span data-ttu-id="dba0a-113">規則の説明</span><span class="sxs-lookup"><span data-stu-id="dba0a-113">Rule description</span></span>

<span data-ttu-id="dba0a-114">非同期メソッドで <xref:System.Threading.Tasks.Task> を直接待機すると、非同期コンテキストによっては、タスクを作成したのと同じスレッドで継続が発生します。</span><span class="sxs-lookup"><span data-stu-id="dba0a-114">When an asynchronous method awaits a <xref:System.Threading.Tasks.Task> directly, continuation usually occurs in the same thread that created the task, depending on the async context.</span></span> <span data-ttu-id="dba0a-115">この動作はパフォーマンスの面で大きな負担が生じ、その結果 UI スレッドでデッドロックが発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dba0a-115">This behavior can be costly in terms of performance and can result in a deadlock on the UI thread.</span></span> <span data-ttu-id="dba0a-116"><xref:System.Threading.Tasks.Task.ConfigureAwait(System.Boolean)?displayProperty=nameWithType> を呼び出して継続の意図を示すことを検討してください。</span><span class="sxs-lookup"><span data-stu-id="dba0a-116">Consider calling <xref:System.Threading.Tasks.Task.ConfigureAwait(System.Boolean)?displayProperty=nameWithType> to signal your intention for continuation.</span></span>

## <a name="how-to-fix-violations"></a><span data-ttu-id="dba0a-117">違反の修正方法</span><span class="sxs-lookup"><span data-stu-id="dba0a-117">How to fix violations</span></span>

<span data-ttu-id="dba0a-118">違反を修正するには、待機した <xref:System.Threading.Tasks.Task> で <xref:System.Threading.Tasks.Task.ConfigureAwait%2A> を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="dba0a-118">To fix violations, call <xref:System.Threading.Tasks.Task.ConfigureAwait%2A> on the awaited <xref:System.Threading.Tasks.Task>.</span></span> <span data-ttu-id="dba0a-119">`continueOnCapturedContext` パラメーターには、`true` または `false` のいずれかを渡すことができます。</span><span class="sxs-lookup"><span data-stu-id="dba0a-119">You can pass either `true` or `false` for the `continueOnCapturedContext` parameter.</span></span>

- <span data-ttu-id="dba0a-120">タスクで `ConfigureAwait(true)` を呼び出すと、明示的に <xref:System.Threading.Tasks.Task.ConfigureAwait%2A> を呼び出さない場合と同じ動作が行われます。</span><span class="sxs-lookup"><span data-stu-id="dba0a-120">Calling `ConfigureAwait(true)` on the task has the same behavior as not explicitly calling <xref:System.Threading.Tasks.Task.ConfigureAwait%2A>.</span></span> <span data-ttu-id="dba0a-121">このメソッドを明示的に呼び出すことにより、元の同期コンテキストで継続を意図的に実行することをリーダーに通知できます。</span><span class="sxs-lookup"><span data-stu-id="dba0a-121">By explicitly calling this method, you're letting readers know you intentionally want to perform the continuation on the original synchronization context.</span></span>

- <span data-ttu-id="dba0a-122">タスクで `ConfigureAwait(false)` を呼び出して、継続をスレッド プールにスケジュールします。これにより、UI スレッドでデッドロックが発生するのを回避できます。</span><span class="sxs-lookup"><span data-stu-id="dba0a-122">Call `ConfigureAwait(false)` on the task to schedule continuations to the thread pool, thereby avoiding a deadlock on the UI thread.</span></span> <span data-ttu-id="dba0a-123">`false` を渡すことは、アプリに依存しないライブラリに適したオプションです。</span><span class="sxs-lookup"><span data-stu-id="dba0a-123">Passing `false` is a good option for app-independent libraries.</span></span>

## <a name="example"></a><span data-ttu-id="dba0a-124">例</span><span class="sxs-lookup"><span data-stu-id="dba0a-124">Example</span></span>

<span data-ttu-id="dba0a-125">次のコード スニペットでは、警告が表示されます。</span><span class="sxs-lookup"><span data-stu-id="dba0a-125">The following code snippet generates the warning:</span></span>

```csharp
public async Task Execute()
{
    Task task = null;
    await task;
}
```

<span data-ttu-id="dba0a-126">違反を修正するには、待機している <xref:System.Threading.Tasks.Task> で <xref:System.Threading.Tasks.Task.ConfigureAwait%2A> を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="dba0a-126">To fix the violation, call <xref:System.Threading.Tasks.Task.ConfigureAwait%2A> on the awaited <xref:System.Threading.Tasks.Task>:</span></span>

```csharp
public async Task Execute()
{
    Task task = null;
    await task.ConfigureAwait(false);
}
```

## <a name="when-to-suppress-warnings"></a><span data-ttu-id="dba0a-127">どのようなときに警告を抑制するか</span><span class="sxs-lookup"><span data-stu-id="dba0a-127">When to suppress warnings</span></span>

<span data-ttu-id="dba0a-128">この警告は、任意の環境でコードを実行するライブラリ、および環境、メソッドの呼び出し元が呼び出す方法、または待機方法についてコードが想定しないライブラリを対象としています。</span><span class="sxs-lookup"><span data-stu-id="dba0a-128">This warning is intended for libraries, where the code may be executed in arbitrary environments and where code shouldn't make assumptions about the environment or how the caller of the method may be invoking or waiting on it.</span></span> <span data-ttu-id="dba0a-129">通常、ライブラリ コードではなく、アプリケーション コードを表すプロジェクトでは、警告を完全に抑制するのが妥当です。実際、このアナライザーをアプリケーション コードで実行すると (たとえば、WinForms または WPF プロジェクトのボタン クリック イベント ハンドラー)、間違ったアクションが実行される可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dba0a-129">It is generally appropriate to suppress the warning entirely for projects that represent application code rather than library code; in fact, running this analyzer on application code (for example, button click event handlers in a WinForms or WPF project) is likely to lead to the wrong actions being taken.</span></span>

<span data-ttu-id="dba0a-130">継続を元のコンテキストに戻すようにスケジュールするか、またはそのようなコンテキストが適切な場所にない場合に、この警告を抑制できます。</span><span class="sxs-lookup"><span data-stu-id="dba0a-130">You can suppress this warning in any situation where either the continuation should be scheduled back to the original context or where there is no such context in place.</span></span> <span data-ttu-id="dba0a-131">たとえば、WinForms または WPF アプリケーションのボタン クリック イベント ハンドラーでコードを記述する場合、通常、待機からの継続は UI スレッドで実行する必要があるため、継続を元のコンテキストに戻す既定の動作が望ましいです。</span><span class="sxs-lookup"><span data-stu-id="dba0a-131">For example, when writing code in a button click event handler in a WinForms or WPF application, in general the continuation from an await should run on the UI thread, and thus the default behavior of scheduling the continuation back to the originating context is desirable.</span></span> <span data-ttu-id="dba0a-132">別の例として、ASP.NET Core アプリケーションでコードを記述する場合、既定では <xref:System.Threading.SynchronizationContext> または <xref:System.Threading.Tasks.TaskScheduler> がありません。そのため、`ConfigureAwait` は実際には動作を変更しません。</span><span class="sxs-lookup"><span data-stu-id="dba0a-132">As another example, when writing code in an ASP.NET Core application, by default there is no <xref:System.Threading.SynchronizationContext> or <xref:System.Threading.Tasks.TaskScheduler>, for which reason a `ConfigureAwait` wouldn't actually change any behavior.</span></span>

[!INCLUDE [suppress-warning](../../../../includes/code-analysis/suppress-warning.md)]

## <a name="configure-code-to-analyze"></a><span data-ttu-id="dba0a-133">分析するコードを構成する</span><span class="sxs-lookup"><span data-stu-id="dba0a-133">Configure code to analyze</span></span>

<span data-ttu-id="dba0a-134">次のオプションを使用して、コードベースのどの部分に対してこのルールを実行するかを構成します。</span><span class="sxs-lookup"><span data-stu-id="dba0a-134">Use the following options to configure which parts of your codebase to run this rule on.</span></span>

- [<span data-ttu-id="dba0a-135">非同期の void メソッドを除外する</span><span class="sxs-lookup"><span data-stu-id="dba0a-135">Exclude async void methods</span></span>](#exclude-async-void-methods)
- [<span data-ttu-id="dba0a-136">出力の種類</span><span class="sxs-lookup"><span data-stu-id="dba0a-136">Output kind</span></span>](#output-kind)

<span data-ttu-id="dba0a-137">これらのオプションを構成できる対象は、この規則だけ、すべての規則、このカテゴリ ([信頼性](reliability-warnings.md)) のすべての規則のいずれかです。</span><span class="sxs-lookup"><span data-stu-id="dba0a-137">You can configure all of these options for just this rule, for all rules, or for all rules in this category ([Reliability](reliability-warnings.md)).</span></span> <span data-ttu-id="dba0a-138">詳細については、「[コード品質規則の構成オプション](../code-quality-rule-options.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="dba0a-138">For more information, see [Code quality rule configuration options](../code-quality-rule-options.md).</span></span>

### <a name="exclude-async-void-methods"></a><span data-ttu-id="dba0a-139">非同期の void メソッドを除外する</span><span class="sxs-lookup"><span data-stu-id="dba0a-139">Exclude async void methods</span></span>

<span data-ttu-id="dba0a-140">値を返さない非同期メソッドをこの規則から除外するかどうかを構成できます。</span><span class="sxs-lookup"><span data-stu-id="dba0a-140">You can configure whether you want to exclude asynchronous methods that don't return a value from this rule.</span></span> <span data-ttu-id="dba0a-141">これらの種類のメソッドを除外するには、プロジェクトの *.editorconfig* ファイルに次のキーと値のペアを追加します。</span><span class="sxs-lookup"><span data-stu-id="dba0a-141">To exclude these kinds of methods, add the following key-value pair to an *.editorconfig* file in your project:</span></span>

```ini
# Package version 2.9.0 and later
dotnet_code_quality.CA2007.exclude_async_void_methods = true

# Package version 2.6.3 and earlier
dotnet_code_quality.CA2007.skip_async_void_methods = true
```

### <a name="output-kind"></a><span data-ttu-id="dba0a-142">出力の種類</span><span class="sxs-lookup"><span data-stu-id="dba0a-142">Output kind</span></span>

<span data-ttu-id="dba0a-143">また、この規則を適用する出力アセンブリの種類を構成することもできます。</span><span class="sxs-lookup"><span data-stu-id="dba0a-143">You can also configure which output assembly kinds to apply this rule to.</span></span> <span data-ttu-id="dba0a-144">たとえば、コンソール アプリケーションまたは動的にリンクされるライブラリ (つまり、UI アプリではない) を生成するコードにのみこの規則を適用するには、プロジェクトの *.editorconfig* ファイルに次のキーと値のペアを追加します。</span><span class="sxs-lookup"><span data-stu-id="dba0a-144">For example, to only apply this rule to code that produces a console application or a dynamically linked library (that is, not a UI app), add the following key-value pair to an *.editorconfig* file in your project:</span></span>

```ini
dotnet_code_quality.CA2007.output_kind = ConsoleApplication, DynamicallyLinkedLibrary
```

## <a name="see-also"></a><span data-ttu-id="dba0a-145">関連項目</span><span class="sxs-lookup"><span data-stu-id="dba0a-145">See also</span></span>

- [<span data-ttu-id="dba0a-146">ConfigureAwait に関する FAQ</span><span class="sxs-lookup"><span data-stu-id="dba0a-146">ConfigureAwait FAQ</span></span>](https://devblogs.microsoft.com/dotnet/configureawait-faq/)
- [<span data-ttu-id="dba0a-147">ConfigureAwait(false) を使用してタスクを待機する必要がありますか?</span><span class="sxs-lookup"><span data-stu-id="dba0a-147">Should I await a task with ConfigureAwait(false)?</span></span>](https://github.com/Microsoft/vs-threading/blob/master/doc/cookbook_vs.md#should-i-await-a-task-with-configureawaitfalse)
- [<span data-ttu-id="dba0a-148">CA2008:TaskScheduler を渡さずにタスクを作成しない</span><span class="sxs-lookup"><span data-stu-id="dba0a-148">CA2008: Do not create tasks without passing a TaskScheduler</span></span>](ca2008.md)
- [<span data-ttu-id="dba0a-149">信頼性の規則</span><span class="sxs-lookup"><span data-stu-id="dba0a-149">Reliability rules</span></span>](reliability-warnings.md)
