---
description: '詳細情報: オブザーバー デザイン パターンのベスト プラクティス'
title: オブサーバー デザイン パターンのベスト プラクティス
ms.date: 03/30/2017
helpviewer_keywords:
- observer design pattern [.NET], best practices
- best practices [.NET], observer design pattern
ms.assetid: c834760f-ddd4-417f-abb7-a059679d5b8c
ms.openlocfilehash: 0c7e739081516776efbabb77ef88dbc3598d7fb9
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/06/2021
ms.locfileid: "99641723"
---
# <a name="observer-design-pattern-best-practices"></a><span data-ttu-id="a115a-103">オブサーバー デザイン パターンのベスト プラクティス</span><span class="sxs-lookup"><span data-stu-id="a115a-103">Observer Design Pattern Best Practices</span></span>

<span data-ttu-id="a115a-104">.NET では、オブザーバー デザイン パターンは、一連のインターフェイスとして実装されます。</span><span class="sxs-lookup"><span data-stu-id="a115a-104">In .NET, the observer design pattern is implemented as a set of interfaces.</span></span> <span data-ttu-id="a115a-105"><xref:System.IObservable%601?displayProperty=nameWithType> インターフェイスはデータ プロバイダーを表し、データ プロバイダーはオブザーバーで通知のサブスクリプションを解除できるようにする <xref:System.IDisposable> 実装も提供します。</span><span class="sxs-lookup"><span data-stu-id="a115a-105">The <xref:System.IObservable%601?displayProperty=nameWithType> interface represents the data provider, which is also responsible for providing an <xref:System.IDisposable> implementation that lets observers unsubscribe from notifications.</span></span> <span data-ttu-id="a115a-106"><xref:System.IObserver%601?displayProperty=nameWithType> インターフェイスはオブザーバーを表します。</span><span class="sxs-lookup"><span data-stu-id="a115a-106">The <xref:System.IObserver%601?displayProperty=nameWithType> interface represents the observer.</span></span> <span data-ttu-id="a115a-107">このトピックでは、これらのインターフェイスを使用してオブザーバー デザイン パターンを実装するときに、開発者が適用することが望ましいベスト プラクティスについて説明します。</span><span class="sxs-lookup"><span data-stu-id="a115a-107">This topic describes the best practices that developers should follow when implementing the observer design pattern using these interfaces.</span></span>  
  
## <a name="threading"></a><span data-ttu-id="a115a-108">スレッド</span><span class="sxs-lookup"><span data-stu-id="a115a-108">Threading</span></span>  

 <span data-ttu-id="a115a-109">通常、プロバイダーは、何らかのコレクション オブジェクトで表されるサブスクライバー リストに特定のオブザーバーを追加することで、<xref:System.IObservable%601.Subscribe%2A?displayProperty=nameWithType> メソッドを実装し、サブスクライバー リストから特定のオブザーバーを削除することで、<xref:System.IDisposable.Dispose%2A?displayProperty=nameWithType> メソッドを実装します。</span><span class="sxs-lookup"><span data-stu-id="a115a-109">Typically, a provider implements the <xref:System.IObservable%601.Subscribe%2A?displayProperty=nameWithType> method by adding a particular observer to a subscriber list that is represented by some collection object, and it implements the <xref:System.IDisposable.Dispose%2A?displayProperty=nameWithType> method by removing a particular observer from the subscriber list.</span></span> <span data-ttu-id="a115a-110">オブザーバーは、これらのメソッドをいつでも呼び出すことができます。</span><span class="sxs-lookup"><span data-stu-id="a115a-110">An observer can call these methods at any time.</span></span> <span data-ttu-id="a115a-111">また、プロバイダー/オブザーバーのコントラクトでは、<xref:System.IObserver%601.OnCompleted%2A?displayProperty=nameWithType> コールバック メソッドの後にだれがサブスクリプションを解除するかが指定されていないため、プロバイダーとオブザーバーの両方で同じメンバーをリストから削除しようとする可能性があります。</span><span class="sxs-lookup"><span data-stu-id="a115a-111">In addition, because the provider/observer contract does not specify who is responsible for unsubscribing after the <xref:System.IObserver%601.OnCompleted%2A?displayProperty=nameWithType> callback method, the provider and observer may both try to remove the same member from the list.</span></span> <span data-ttu-id="a115a-112">このような可能性があるため、<xref:System.IObservable%601.Subscribe%2A> メソッドと <xref:System.IDisposable.Dispose%2A> メソッドはどちらもスレッド セーフである必要があります。</span><span class="sxs-lookup"><span data-stu-id="a115a-112">Because of this possibility, both the <xref:System.IObservable%601.Subscribe%2A> and <xref:System.IDisposable.Dispose%2A> methods should be thread-safe.</span></span> <span data-ttu-id="a115a-113">通常、これには、[同時実行コレクション](../parallel-programming/data-structures-for-parallel-programming.md)またはロックの使用が必要です。</span><span class="sxs-lookup"><span data-stu-id="a115a-113">Typically, this involves using a [concurrent collection](../parallel-programming/data-structures-for-parallel-programming.md) or a lock.</span></span> <span data-ttu-id="a115a-114">非スレッド セーフの実装では、スレッド セーフではないことが明示的に記載されている必要があります。</span><span class="sxs-lookup"><span data-stu-id="a115a-114">Implementations that are not thread-safe should explicitly document that they are not.</span></span>  
  
 <span data-ttu-id="a115a-115">その他の保証は、プロバイダー/オブザーバーのコントラクトの最上部のレイヤーで指定されている必要があります。</span><span class="sxs-lookup"><span data-stu-id="a115a-115">Any additional guarantees have to be specified in a layer on top of the provider/observer contract.</span></span> <span data-ttu-id="a115a-116">実装側で要件を追加する場合には、ユーザーがオブザーバー コントラクトについて混乱しないように明確に示す必要があります。</span><span class="sxs-lookup"><span data-stu-id="a115a-116">Implementers should clearly call out when they impose additional requirements to avoid user confusion about the observer contract.</span></span>  
  
## <a name="handling-exceptions"></a><span data-ttu-id="a115a-117">例外処理</span><span class="sxs-lookup"><span data-stu-id="a115a-117">Handling Exceptions</span></span>  

 <span data-ttu-id="a115a-118">データ プロバイダーとオブザーバーの結合は疎であるため、オブザーバー デザイン パターンの例外は情報提供を目的としています。</span><span class="sxs-lookup"><span data-stu-id="a115a-118">Because of the loose coupling between a data provider and an observer, exceptions in the observer design pattern are intended to be informational.</span></span> <span data-ttu-id="a115a-119">このことは、プロバイダーとオブザーバーがオブザーバー デザイン パターンの例外を処理する方法に影響します。</span><span class="sxs-lookup"><span data-stu-id="a115a-119">This affects how providers and observers handle exceptions in the observer design pattern.</span></span>  
  
### <a name="the-provider----calling-the-onerror-method"></a><span data-ttu-id="a115a-120">プロバイダー -- OnError メソッドの呼び出し</span><span class="sxs-lookup"><span data-stu-id="a115a-120">The Provider -- Calling the OnError Method</span></span>  

 <span data-ttu-id="a115a-121"><xref:System.IObserver%601.OnError%2A> メソッドは、<xref:System.IObserver%601.OnNext%2A?displayProperty=nameWithType> メソッドと同様に、オブザーバーへの情報メッセージとして使用されます。</span><span class="sxs-lookup"><span data-stu-id="a115a-121">The <xref:System.IObserver%601.OnError%2A> method is intended as an informational message to observers, much like the <xref:System.IObserver%601.OnNext%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="a115a-122">ただし、<xref:System.IObserver%601.OnNext%2A> メソッドが、現在のデータまたは更新されたデータをオブザーバーに提供するように設計されているのに対して、<xref:System.IObserver%601.OnError%2A> メソッドは、プロバイダーが有効なデータを提供できないことを示すように設計されています。</span><span class="sxs-lookup"><span data-stu-id="a115a-122">However, the <xref:System.IObserver%601.OnNext%2A> method is designed to provide an observer with current or updated data, whereas the <xref:System.IObserver%601.OnError%2A> method is designed to indicate that the provider is unable to provide valid data.</span></span>  
  
 <span data-ttu-id="a115a-123">例外を処理して <xref:System.IObserver%601.OnError%2A> メソッドを呼び出す場合、プロバイダーが次のベスト プラクティスに従うことをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="a115a-123">The provider should follow these best practices when handling exceptions and calling the <xref:System.IObserver%601.OnError%2A> method:</span></span>  
  
- <span data-ttu-id="a115a-124">プロバイダーに固有の要件がある場合、プロバイダーは独自の例外を処理する必要があります。</span><span class="sxs-lookup"><span data-stu-id="a115a-124">The provider must handle its own exceptions if it has any specific requirements.</span></span>  
  
- <span data-ttu-id="a115a-125">プロバイダーは、オブザーバーが特定の方法で例外を処理することを期待または要求しないようにします。</span><span class="sxs-lookup"><span data-stu-id="a115a-125">The provider should not expect or require that observers handle exceptions in any particular way.</span></span>  
  
- <span data-ttu-id="a115a-126">更新を提供する機能を損なうような例外を処理する場合、プロバイダーは <xref:System.IObserver%601.OnError%2A> メソッドを呼び出す必要があります。</span><span class="sxs-lookup"><span data-stu-id="a115a-126">The provider should call the <xref:System.IObserver%601.OnError%2A> method when it handles an exception that compromises its ability to provide updates.</span></span> <span data-ttu-id="a115a-127">このような例外の情報はオブザーバーに渡すことができます。</span><span class="sxs-lookup"><span data-stu-id="a115a-127">Information on such exceptions can be passed to the observer.</span></span> <span data-ttu-id="a115a-128">それ以外の場合は、オブザーバーに例外を通知する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="a115a-128">In other cases, there is no need to notify observers of an exception.</span></span>  
  
 <span data-ttu-id="a115a-129">プロバイダーが <xref:System.IObserver%601.OnError%2A> メソッドまたは <xref:System.IObserver%601.OnCompleted%2A?displayProperty=nameWithType> メソッドを呼び出すと、それ以上の通知は行われなくなるため、プロバイダーはそのオブザーバーのサブスクリプションを解除することができます。</span><span class="sxs-lookup"><span data-stu-id="a115a-129">Once the provider calls the <xref:System.IObserver%601.OnError%2A> or <xref:System.IObserver%601.OnCompleted%2A?displayProperty=nameWithType> method, there should be no further notifications, and the provider can unsubscribe its observers.</span></span> <span data-ttu-id="a115a-130">ただし、オブザーバーも、<xref:System.IObserver%601.OnError%2A> 通知または <xref:System.IObserver%601.OnCompleted%2A?displayProperty=nameWithType> 通知を受信する前と後の両方を含め、いつでも自分自身のサブスクリプションを解除できます。</span><span class="sxs-lookup"><span data-stu-id="a115a-130">However, the observers can also unsubscribe themselves at any time, including both before and after they receive an <xref:System.IObserver%601.OnError%2A> or <xref:System.IObserver%601.OnCompleted%2A?displayProperty=nameWithType> notification.</span></span> <span data-ttu-id="a115a-131">オブザーバー デザイン パターンでは、プロバイダーとオブザーバーのどちらがサブスクリプションの解除を行うかは指定しません。そのため、両方でサブスクリプションの解除を試みる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="a115a-131">The observer design pattern does not dictate whether the provider or the observer is responsible for unsubscribing; therefore, there is a possibility that both may attempt to unsubscribe.</span></span> <span data-ttu-id="a115a-132">通常、オブザーバーは、サブスクリプションを解除すると、サブスクライバーのコレクションから削除されます。</span><span class="sxs-lookup"><span data-stu-id="a115a-132">Typically, when observers unsubscribe, they are removed from a subscribers collection.</span></span> <span data-ttu-id="a115a-133">シングルスレッド アプリケーションでは、削除を試みる前に、オブジェクト参照が有効であること、およびオブジェクトがサブスクライバーのコレクションのメンバーであることを、<xref:System.IDisposable.Dispose%2A?displayProperty=nameWithType> の実装で確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="a115a-133">In a single-threaded application, the <xref:System.IDisposable.Dispose%2A?displayProperty=nameWithType> implementation should ensure that an object reference is valid and that the object is a member of the subscribers collection before attempting to remove it.</span></span> <span data-ttu-id="a115a-134">マルチスレッド アプリケーションでは、<xref:System.Collections.Concurrent.BlockingCollection%601?displayProperty=nameWithType> オブジェクトなどのスレッド セーフなコレクション オブジェクトを使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="a115a-134">In a multithreaded application, a thread-safe collection object, such as a <xref:System.Collections.Concurrent.BlockingCollection%601?displayProperty=nameWithType> object, should be used.</span></span>  
  
### <a name="the-observer----implementing-the-onerror-method"></a><span data-ttu-id="a115a-135">オブザーバー -- OnError メソッドの実装</span><span class="sxs-lookup"><span data-stu-id="a115a-135">The Observer -- Implementing the OnError Method</span></span>  

 <span data-ttu-id="a115a-136">プロバイダーからエラー通知を受信した場合、オブザーバーは例外を情報として処理する必要がありますが、特定のアクションの実行は要求されません。</span><span class="sxs-lookup"><span data-stu-id="a115a-136">When an observer receives an error notification from a provider, the observer should treat the exception as informational and should not be required to take any particular action.</span></span>  
  
 <span data-ttu-id="a115a-137">プロバイダーからの <xref:System.IObserver%601.OnError%2A> メソッド呼び出しに応答する場合、オブザーバーが次のベスト プラクティスに従うことをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="a115a-137">The observer should follow these best practices when responding to an <xref:System.IObserver%601.OnError%2A> method call from a provider:</span></span>  
  
- <span data-ttu-id="a115a-138"><xref:System.IObserver%601.OnNext%2A> または <xref:System.IObserver%601.OnError%2A> などのインターフェイス実装からオブザーバーが例外をスローすることを回避するようにします。</span><span class="sxs-lookup"><span data-stu-id="a115a-138">The observer should not throw exceptions from its interface implementations, such as <xref:System.IObserver%601.OnNext%2A> or <xref:System.IObserver%601.OnError%2A>.</span></span> <span data-ttu-id="a115a-139">オブザーバーが例外をスローする場合は、これらの例外が未処理になることを想定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="a115a-139">However, if the observer does throw exceptions, it should expect these exceptions to go unhandled.</span></span>  
  
- <span data-ttu-id="a115a-140">呼び出し履歴を保持するために、<xref:System.Exception> メソッドに渡された <xref:System.IObserver%601.OnError%2A> オブジェクトをスローするオブザーバーは、オブジェクトをスローする前に例外をラップする必要があります。</span><span class="sxs-lookup"><span data-stu-id="a115a-140">To preserve the call stack, an observer that wishes to throw an <xref:System.Exception> object that was passed to its <xref:System.IObserver%601.OnError%2A> method should wrap the exception before throwing it.</span></span> <span data-ttu-id="a115a-141">このためには、標準の例外オブジェクトを使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="a115a-141">A standard exception object should be used for this purpose.</span></span>  
  
## <a name="additional-best-practices"></a><span data-ttu-id="a115a-142">その他のベスト プラクティス</span><span class="sxs-lookup"><span data-stu-id="a115a-142">Additional Best Practices</span></span>  

 <span data-ttu-id="a115a-143"><xref:System.IObservable%601.Subscribe%2A?displayProperty=nameWithType> メソッドで登録を解除しようとすると、null 参照になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="a115a-143">Attempting to unregister in the <xref:System.IObservable%601.Subscribe%2A?displayProperty=nameWithType> method may result in a null reference.</span></span> <span data-ttu-id="a115a-144">そのため、この方法は避けることをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="a115a-144">Therefore, we recommend that you avoid this practice.</span></span>  
  
 <span data-ttu-id="a115a-145">1 つのオブザーバーを複数のプロバイダーにアタッチすることは可能ですが、推奨パターンは、<xref:System.IObserver%601> インスタンスを 1 つの <xref:System.IObservable%601> インスタンスにのみアタッチすることです。</span><span class="sxs-lookup"><span data-stu-id="a115a-145">Although it is possible to attach an observer to multiple providers, the recommended pattern is to attach an <xref:System.IObserver%601> instance to only one <xref:System.IObservable%601> instance.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="a115a-146">参照</span><span class="sxs-lookup"><span data-stu-id="a115a-146">See also</span></span>

- [<span data-ttu-id="a115a-147">オブサーバー デザイン パターン</span><span class="sxs-lookup"><span data-stu-id="a115a-147">Observer Design Pattern</span></span>](observer-design-pattern.md)
- [<span data-ttu-id="a115a-148">方法: オブザーバーを実装する</span><span class="sxs-lookup"><span data-stu-id="a115a-148">How to: Implement an Observer</span></span>](how-to-implement-an-observer.md)
- [<span data-ttu-id="a115a-149">方法: プロバイダーを実装する</span><span class="sxs-lookup"><span data-stu-id="a115a-149">How to: Implement a Provider</span></span>](how-to-implement-a-provider.md)
