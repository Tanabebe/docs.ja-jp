---
description: '詳細情報: スレッド ローカル ストレージ (スレッド相対静的フィールドとデータ スロット)'
title: 'スレッド ローカル ストレージ : スレッド相対静的フィールドとデータ スロット'
ms.date: 03/30/2017
helpviewer_keywords:
- threading [.NET], local storage
- threading [.NET], thread-relative static fields
- local thread storage
- TLS
ms.assetid: c633a4dc-a790-4ed1-96b5-f72bd968b284
ms.openlocfilehash: a7da615e805da6fdc54587829957cad61d17c7a3
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/06/2021
ms.locfileid: "99675443"
---
# <a name="thread-local-storage-thread-relative-static-fields-and-data-slots"></a><span data-ttu-id="27d66-103">スレッド ローカル ストレージ : スレッド相対静的フィールドとデータ スロット</span><span class="sxs-lookup"><span data-stu-id="27d66-103">Thread Local Storage: Thread-Relative Static Fields and Data Slots</span></span>

<span data-ttu-id="27d66-104">1 つのスレッドとアプリケーション ドメインに固有のデータを格納するには、マネージド スレッド ローカル ストレージ (TLS: Thread Local Storage) を使用します。</span><span class="sxs-lookup"><span data-stu-id="27d66-104">You can use managed thread local storage (TLS) to store data that's unique to a thread and application domain.</span></span> <span data-ttu-id="27d66-105">.NET は、マネージド TLS の使用に関して、スレッド相対静的フィールドとデータ スロットという 2 つの機構を備えています。</span><span class="sxs-lookup"><span data-stu-id="27d66-105">.NET provides two ways to use managed TLS: thread-relative static fields and data slots.</span></span>  
  
- <span data-ttu-id="27d66-106">コンパイル時に要件を正確に予測できる場合は、スレッド相対静的フィールド (Visual Basic ではスレッド相対 `Shared` フィールド) を使用します。</span><span class="sxs-lookup"><span data-stu-id="27d66-106">Use thread-relative static fields (thread-relative `Shared` fields in Visual Basic) if you can anticipate your exact needs at compile time.</span></span> <span data-ttu-id="27d66-107">スレッド相対静的フィールドは、最適なパフォーマンスを提供します。</span><span class="sxs-lookup"><span data-stu-id="27d66-107">Thread-relative static fields provide the best performance.</span></span> <span data-ttu-id="27d66-108">また、コンパイル時に型チェックを利用することもできます。</span><span class="sxs-lookup"><span data-stu-id="27d66-108">They also give you the benefits of compile-time type checking.</span></span>  
  
- <span data-ttu-id="27d66-109">実行時にならないと実際の要件がわからない場合は、データ スロットを使用します。</span><span class="sxs-lookup"><span data-stu-id="27d66-109">Use data slots when your actual requirements might be discovered only at run time.</span></span> <span data-ttu-id="27d66-110">データ スロットは、スレッド相対静的フィールドと比べると低速で使いにくく、データは <xref:System.Object> 型として格納されるため、使用前に適切な型にキャストする必要があります。</span><span class="sxs-lookup"><span data-stu-id="27d66-110">Data slots are slower and more awkward to use than thread-relative static fields, and data is stored as type <xref:System.Object>, so you must cast it to the correct type before you use it.</span></span>  
  
 <span data-ttu-id="27d66-111">アンマネージ C++ では、`TlsAlloc` を使用してスロットを動的に割り当て、`__declspec(thread)` を使用して、変数をスレッド相対ストレージに割り当てることを宣言します。</span><span class="sxs-lookup"><span data-stu-id="27d66-111">In unmanaged C++, you use `TlsAlloc` to allocate slots dynamically and `__declspec(thread)` to declare that a variable should be allocated in thread-relative storage.</span></span> <span data-ttu-id="27d66-112">スレッド相対静的フィールドおよびデータ スロットには、この動作のマネージド バージョンが用意されています。</span><span class="sxs-lookup"><span data-stu-id="27d66-112">Thread-relative static fields and data slots provide the managed version of this behavior.</span></span>  
  
<span data-ttu-id="27d66-113"><xref:System.Threading.ThreadLocal%601?displayProperty=nameWithType> クラスを使用して、最初に利用されるときに遅れて初期化されるスレッドローカル オブジェクトを作成できます。</span><span class="sxs-lookup"><span data-stu-id="27d66-113">You can use the <xref:System.Threading.ThreadLocal%601?displayProperty=nameWithType> class to create thread-local objects that are initialized lazily when the object is first consumed.</span></span> <span data-ttu-id="27d66-114">詳細については、「[限定的な初期化](../../framework/performance/lazy-initialization.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="27d66-114">For more information, see [Lazy Initialization](../../framework/performance/lazy-initialization.md).</span></span>  
  
## <a name="uniqueness-of-data-in-managed-tls"></a><span data-ttu-id="27d66-115">マネージド TLS でのデータの一意性</span><span class="sxs-lookup"><span data-stu-id="27d66-115">Uniqueness of Data in Managed TLS</span></span>  

 <span data-ttu-id="27d66-116">スレッド相対静的フィールドとデータ スロットのどちらを使用しても、マネージド TLS でのデータはスレッドとアプリケーション ドメインの組み合わせに対して一意になります。</span><span class="sxs-lookup"><span data-stu-id="27d66-116">Whether you use thread-relative static fields or data slots, data in managed TLS is unique to the combination of thread and application domain.</span></span>  
  
- <span data-ttu-id="27d66-117">アプリケーション ドメインでは、両方のスレッドが同じフィールドまたはスロットを使用していたとしても、一方のスレッドが、もう一方のスレッドからのデータを変更することはできません。</span><span class="sxs-lookup"><span data-stu-id="27d66-117">Within an application domain, one thread cannot modify data from another thread, even when both threads use the same field or slot.</span></span>  
  
- <span data-ttu-id="27d66-118">あるスレッドが、複数のアプリケーション ドメインから 1 つのフィールドまたはスロットにアクセスする場合、アプリケーション ドメインごとに個別の値が維持されます。</span><span class="sxs-lookup"><span data-stu-id="27d66-118">When a thread accesses the same field or slot from multiple application domains, a separate value is maintained in each application domain.</span></span>  
  
 <span data-ttu-id="27d66-119">たとえば、スレッドがスレッド相対静的フィールドの値を設定し、別のアプリケーション ドメインに移動して、設定したフィールドの値を取得した場合、2 番目のアプリケーション ドメインで取得した値は、最初のアプリケーション ドメインでの値とは異なります。</span><span class="sxs-lookup"><span data-stu-id="27d66-119">For example, if a thread sets the value of a thread-relative static field, enters another application domain, and then retrieves the value of the field, the value retrieved in the second application domain differs from the value in the first application domain.</span></span> <span data-ttu-id="27d66-120">2 番目のアプリケーション ドメインのフィールドに新しい値を設定しても、最初のアプリケーション ドメインにあるフィールドの値には影響しません。</span><span class="sxs-lookup"><span data-stu-id="27d66-120">Setting a new value for the field in the second application domain does not affect the field's value in the first application domain.</span></span>  
  
 <span data-ttu-id="27d66-121">同様に、スレッドが、異なる 2 つのアプリケーション ドメインで同じ名前付きデータ スロットを取得した場合、最初のアプリケーション ドメインのデータと 2 番目のアプリケーション ドメインのデータは、それぞれ独立したものとなります。</span><span class="sxs-lookup"><span data-stu-id="27d66-121">Similarly, when a thread gets the same named data slot in two different application domains, the data in the first application domain remains independent of the data in the second application domain.</span></span>  
  
## <a name="thread-relative-static-fields"></a><span data-ttu-id="27d66-122">スレッド相対静的フィールド</span><span class="sxs-lookup"><span data-stu-id="27d66-122">Thread-Relative Static Fields</span></span>  

 <span data-ttu-id="27d66-123">スレッドとアプリケーション ドメインの組み合わせに対し、データの一部が常に一意であることがわかっている場合は、静的フィールドに <xref:System.ThreadStaticAttribute> 属性を適用します。</span><span class="sxs-lookup"><span data-stu-id="27d66-123">If you know that a piece of data is always unique to a thread and application-domain combination, apply the <xref:System.ThreadStaticAttribute> attribute to the static field.</span></span> <span data-ttu-id="27d66-124">このフィールドの使用法は、他の静的フィールドと同様です。</span><span class="sxs-lookup"><span data-stu-id="27d66-124">Use the field as you would use any other static field.</span></span> <span data-ttu-id="27d66-125">フィールドのデータは、使用する各スレッドに対して一意です。</span><span class="sxs-lookup"><span data-stu-id="27d66-125">The data in the field is unique to each thread that uses it.</span></span>  
  
 <span data-ttu-id="27d66-126">スレッド相対静的フィールドは、データ スロットと比較してパフォーマンスが優れており、コンパイル時の型チェックも可能です。</span><span class="sxs-lookup"><span data-stu-id="27d66-126">Thread-relative static fields provide better performance than data slots and have the benefit of compile-time type checking.</span></span>  
  
 <span data-ttu-id="27d66-127">クラス コンストラクター コードはいずれも、そのフィールドにアクセスする最初のコンテキストの最初のスレッドで実行されることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="27d66-127">Be aware that any class constructor code will run on the first thread in the first context that accesses the field.</span></span> <span data-ttu-id="27d66-128">同じアプリケーション ドメイン内にある、その他のすべてのスレッドまたはコンテキストについては、これらのフィールドが参照型の場合は `null` (Visual Basic では `Nothing`) に、値型の場合は既定値に初期化されます。</span><span class="sxs-lookup"><span data-stu-id="27d66-128">In all other threads or contexts in the same application domain, the fields will be initialized to `null` (`Nothing` in Visual Basic) if they are reference types, or to their default values if they are value types.</span></span> <span data-ttu-id="27d66-129">したがって、クラス コンストラクターを使用してスレッド相対静的フィールドを初期化しないでください。</span><span class="sxs-lookup"><span data-stu-id="27d66-129">Therefore, you should not rely on class constructors to initialize thread-relative static fields.</span></span> <span data-ttu-id="27d66-130">スレッド相対静的フィールドの初期化は回避し、これらのフィールドが `null` (`Nothing`) または既定値に初期化されると仮定します。</span><span class="sxs-lookup"><span data-stu-id="27d66-130">Instead, avoid initializing thread-relative static fields and assume that they are initialized to `null` (`Nothing`) or to their default values.</span></span>  
  
## <a name="data-slots"></a><span data-ttu-id="27d66-131">データ スロット</span><span class="sxs-lookup"><span data-stu-id="27d66-131">Data Slots</span></span>  

<span data-ttu-id="27d66-132">.NET には、スレッドとアプリケーション ドメインの組み合わせに対して一意の、動的なデータ スロットが用意されています。</span><span class="sxs-lookup"><span data-stu-id="27d66-132">.NET provides dynamic data slots that are unique to a combination of thread and application domain.</span></span> <span data-ttu-id="27d66-133">このデータ スロットには 2 つのタイプがあります。名前付きスロットと名前のないスロットです。</span><span class="sxs-lookup"><span data-stu-id="27d66-133">There are two types of data slots: named slots and unnamed slots.</span></span> <span data-ttu-id="27d66-134">いずれも、<xref:System.LocalDataStoreSlot> 構造体を使用して実装されます。</span><span class="sxs-lookup"><span data-stu-id="27d66-134">Both are implemented by using the <xref:System.LocalDataStoreSlot> structure.</span></span>  
  
- <span data-ttu-id="27d66-135">名前付きデータ スロットを作成するには、<xref:System.Threading.Thread.AllocateNamedDataSlot%2A?displayProperty=nameWithType> メソッドまたは <xref:System.Threading.Thread.GetNamedDataSlot%2A?displayProperty=nameWithType> メソッドを使用します。</span><span class="sxs-lookup"><span data-stu-id="27d66-135">To create a named data slot, use the <xref:System.Threading.Thread.AllocateNamedDataSlot%2A?displayProperty=nameWithType> or <xref:System.Threading.Thread.GetNamedDataSlot%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="27d66-136">既存の名前付きスロットへの参照を取得するには、その名前を <xref:System.Threading.Thread.GetNamedDataSlot%2A> メソッドに渡します。</span><span class="sxs-lookup"><span data-stu-id="27d66-136">To get a reference to an existing named slot, pass its name to the <xref:System.Threading.Thread.GetNamedDataSlot%2A> method.</span></span>  
  
- <span data-ttu-id="27d66-137">名前のないデータ スロットを作成するには、<xref:System.Threading.Thread.AllocateDataSlot%2A?displayProperty=nameWithType> メソッドを使用します。</span><span class="sxs-lookup"><span data-stu-id="27d66-137">To create an unnamed data slot, use the <xref:System.Threading.Thread.AllocateDataSlot%2A?displayProperty=nameWithType> method.</span></span>  
  
 <span data-ttu-id="27d66-138">名前付きスロットと名前のないスロットはいずれも、<xref:System.Threading.Thread.SetData%2A?displayProperty=nameWithType> メソッドと <xref:System.Threading.Thread.GetData%2A?displayProperty=nameWithType> メソッドを使用して、スロット内のデータの設定や取得を行います。</span><span class="sxs-lookup"><span data-stu-id="27d66-138">For both named and unnamed slots, use the <xref:System.Threading.Thread.SetData%2A?displayProperty=nameWithType> and <xref:System.Threading.Thread.GetData%2A?displayProperty=nameWithType> methods to set and retrieve the information in the slot.</span></span> <span data-ttu-id="27d66-139">これらは静的メソッドであり、現在実行中であるスレッドのデータを操作する役割を果たします。</span><span class="sxs-lookup"><span data-stu-id="27d66-139">These are static methods that always act on the data for the thread that is currently executing them.</span></span>  
  
 <span data-ttu-id="27d66-140">名前付きスロットは、必要なときに <xref:System.Threading.Thread.GetNamedDataSlot%2A> メソッドにスロットの名前を渡してスロットを取得できるという利点があります (名前のないスロットの場合は、スロットへの参照を維持する必要があります)。</span><span class="sxs-lookup"><span data-stu-id="27d66-140">Named slots can be convenient, because you can retrieve the slot when you need it by passing its name to the <xref:System.Threading.Thread.GetNamedDataSlot%2A> method, instead of maintaining a reference to an unnamed slot.</span></span> <span data-ttu-id="27d66-141">ただし、他のコンポーネントがそのスレッド相対ストレージに対して同じ名前を使用しており、1 つのスレッドが、ご使用のコンポーネントとその他のコンポーネントの両方からコードを実行する場合、この 2 つのコンポーネントが互いのデータを破損する可能性があります</span><span class="sxs-lookup"><span data-stu-id="27d66-141">However, if another component uses the same name for its thread-relative storage and a thread executes code from both your component and the other component, the two components might corrupt each other's data.</span></span> <span data-ttu-id="27d66-142">(このシナリオでは、2 つのコンポーネントが同じアプリケーション ドメイン内で実行されており、同じデータを共有するようには設計されていないことを前提としています)。</span><span class="sxs-lookup"><span data-stu-id="27d66-142">(This scenario assumes that both components are running in the same application domain, and that they are not designed to share the same data.)</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="27d66-143">参照</span><span class="sxs-lookup"><span data-stu-id="27d66-143">See also</span></span>

- <xref:System.ContextStaticAttribute>
- <xref:System.Threading.Thread.GetNamedDataSlot%2A?displayProperty=nameWithType>
- <xref:System.ThreadStaticAttribute>
- <xref:System.Runtime.Remoting.Messaging.CallContext>
- [<span data-ttu-id="27d66-144">スレッド化</span><span class="sxs-lookup"><span data-stu-id="27d66-144">Threading</span></span>](index.md)
