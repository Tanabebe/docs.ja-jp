---
title: 非同期の戻り値の型 (C#)
description: 各型およびその他のリソースのコード例と共に非同期メソッドが C# で持つことのできる戻り値の型について説明します。
ms.date: 08/19/2020
ms.assetid: ddb2539c-c898-48c1-ad92-245e4a996df8
ms.openlocfilehash: 53eb3bedebb99cd829101eee4c2e190c0fb952bf
ms.sourcegitcommit: 1dbe25ff484a02025d5c34146e517c236f7161fb
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/19/2021
ms.locfileid: "104653453"
---
# <a name="async-return-types-c"></a><span data-ttu-id="0f7b2-103">非同期の戻り値の型 (C#)</span><span class="sxs-lookup"><span data-stu-id="0f7b2-103">Async return types (C#)</span></span>

<span data-ttu-id="0f7b2-104">非同期メソッドには、次の戻り値の型があります。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-104">Async methods can have the following return types:</span></span>

- <span data-ttu-id="0f7b2-105"><xref:System.Threading.Tasks.Task>: 操作を実行し、値を返さない非同期メソッドの場合。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-105"><xref:System.Threading.Tasks.Task>, for an async method that performs an operation but returns no value.</span></span>
- <span data-ttu-id="0f7b2-106"><xref:System.Threading.Tasks.Task%601>: 値を返す非同期メソッドの場合。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-106"><xref:System.Threading.Tasks.Task%601>, for an async method that returns a value.</span></span>
- <span data-ttu-id="0f7b2-107">`void`: イベント ハンドラーの場合。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-107">`void`, for an event handler.</span></span>
- <span data-ttu-id="0f7b2-108">C# 7.0 以降、アクセス可能な `GetAwaiter` を持つ任意の型です。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-108">Starting with C# 7.0, any type that has an accessible `GetAwaiter` method.</span></span> <span data-ttu-id="0f7b2-109"><xref:System.Runtime.CompilerServices.ICriticalNotifyCompletion?displayProperty=nameWithType> メソッドによって返されるオブジェクトは、`GetAwaiter` インターフェイスを実装する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-109">The object returned by the `GetAwaiter` method must implement the <xref:System.Runtime.CompilerServices.ICriticalNotifyCompletion?displayProperty=nameWithType> interface.</span></span>
- <span data-ttu-id="0f7b2-110">C# 8.0 以降、"*非同期ストリーム*" を返す非同期メソッドの場合は <xref:System.Collections.Generic.IAsyncEnumerable%601>。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-110">Starting with C# 8.0, <xref:System.Collections.Generic.IAsyncEnumerable%601>, for an async method that returns an *async stream*.</span></span>

<span data-ttu-id="0f7b2-111">非同期メソッドの詳細については、「[Async および Await を使用した非同期プログラミング (C#)](./index.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-111">For more information about async methods, see [Asynchronous programming with async and await (C#)](./index.md).</span></span>

<span data-ttu-id="0f7b2-112">他にも、Windows ワークロードに固有の型がいくつか存在します。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-112">Several other types also exist that are specific to Windows workloads:</span></span>

- <span data-ttu-id="0f7b2-113"><xref:System.Windows.Threading.DispatcherOperation>: Windows に限定された非同期操作。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-113"><xref:System.Windows.Threading.DispatcherOperation>, for async operations limited to Windows.</span></span>
- <span data-ttu-id="0f7b2-114"><xref:Windows.Foundation.IAsyncAction>: 値を返さない UWP の非同期アクション。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-114"><xref:Windows.Foundation.IAsyncAction>, for async actions in UWP that do not return a value.</span></span>
- <span data-ttu-id="0f7b2-115"><xref:Windows.Foundation.IAsyncActionWithProgress%601>: 進行状況は報告するが値を返さない UWP の非同期アクション。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-115"><xref:Windows.Foundation.IAsyncActionWithProgress%601>, for async actions in UWP that report progress but do not return a value.</span></span>
- <span data-ttu-id="0f7b2-116"><xref:Windows.Foundation.IAsyncOperation%601>: 値を返す UWP の非同期操作。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-116"><xref:Windows.Foundation.IAsyncOperation%601>, for async operations in UWP that return a value.</span></span>
- <span data-ttu-id="0f7b2-117"><xref:Windows.Foundation.IAsyncOperationWithProgress%602>: 進行状況を報告し値を返す UWP の非同期操作。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-117"><xref:Windows.Foundation.IAsyncOperationWithProgress%602>, for async operations in UWP that report progress and return a value.</span></span>

## <a name="task-return-type"></a><span data-ttu-id="0f7b2-118">Task の戻り値の型</span><span class="sxs-lookup"><span data-stu-id="0f7b2-118">Task return type</span></span>

<span data-ttu-id="0f7b2-119">`return` ステートメントを含まない非同期メソッド、またはオペランドを返さない `return` ステートメントを含む非同期メソッドは、通常は <xref:System.Threading.Tasks.Task> の戻り値の型を指定します。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-119">Async methods that don't contain a `return` statement or that contain a `return` statement that doesn't return an operand usually have a return type of <xref:System.Threading.Tasks.Task>.</span></span> <span data-ttu-id="0f7b2-120">こうしたメソッドは、同期的に実行するように作成されている場合に `void` を返します。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-120">Such methods return `void` if they run synchronously.</span></span> <span data-ttu-id="0f7b2-121">非同期メソッドに戻り値の型 <xref:System.Threading.Tasks.Task> を使用した場合、呼び出し元のメソッドは `await` 演算子を使って、呼び出された async のメソッドが終了するまで、呼び出し元の完了を中断します。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-121">If you use a <xref:System.Threading.Tasks.Task> return type for an async method, a calling method can use an `await` operator to suspend the caller's completion until the called async method has finished.</span></span>

<span data-ttu-id="0f7b2-122">次の例では、`WaitAndApologizeAsync` メソッドに `return` ステートメントが含まれていないため、メソッドからは <xref:System.Threading.Tasks.Task> オブジェクトが返されます。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-122">In the following example, the `WaitAndApologizeAsync` method doesn't contain a `return` statement, so the method returns a <xref:System.Threading.Tasks.Task> object.</span></span> <span data-ttu-id="0f7b2-123">`Task` を返すことで、`WaitAndApologizeAsync` を待機できるようになります。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-123">Returning a `Task` enables `WaitAndApologizeAsync` to be awaited.</span></span> <span data-ttu-id="0f7b2-124"><xref:System.Threading.Tasks.Task> 型には戻り値がないため、`Result` プロパティを含みません。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-124">The <xref:System.Threading.Tasks.Task> type doesn't include a `Result` property because it has no return value.</span></span>

:::code language="csharp" source="snippets/async-return-types/async-returns2.cs" id="TaskReturn":::

<span data-ttu-id="0f7b2-125">`WaitAndApologizeAsync` を待機するには、void を返す同期メソッドを呼び出す場合と同様に、await 式でなく、await ステートメントを使用します。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-125">`WaitAndApologizeAsync` is awaited by using an await statement instead of an await expression, similar to the calling statement for a synchronous void-returning method.</span></span> <span data-ttu-id="0f7b2-126">この場合、await 演算子の適用によって値は生成されません。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-126">The application of an await operator in this case doesn't produce a value.</span></span> <span data-ttu-id="0f7b2-127">`await` の右オペランドが <xref:System.Threading.Tasks.Task%601> の場合、`await` 式によって、`T` の結果が生成されます。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-127">When the right operand of an `await` is a <xref:System.Threading.Tasks.Task%601>, the `await` expression produces a result of `T`.</span></span> <span data-ttu-id="0f7b2-128">`await` の右オペランドが、<xref:System.Threading.Tasks.Task> の場合、`await` とそのオペランドはステートメントです。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-128">When the right operand of an `await` is a <xref:System.Threading.Tasks.Task>, the `await` and its operand are a statement.</span></span>

<span data-ttu-id="0f7b2-129">次のコードを見るとわかるように、`WaitAndApologizeAsync` の呼び出しを await 演算子の適用から分離することができます。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-129">You can separate the call to `WaitAndApologizeAsync` from the application of an await operator, as the following code shows.</span></span> <span data-ttu-id="0f7b2-130">ただし `Task` は `Result` プロパティを持たないこと、また await 演算子が `Task` に適用されるときに値は生成されないことに注意します。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-130">However, remember that a `Task` doesn't have a `Result` property, and that no value is produced when an await operator is applied to a `Task`.</span></span>

<span data-ttu-id="0f7b2-131">次のコードは、`WaitAndApologizeAsync` メソッドの呼び出しを、そのメソッドが返すタスクの待機から分離します。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-131">The following code separates calling the `WaitAndApologizeAsync` method from awaiting the task that the method returns.</span></span>

:::code language="csharp" source="snippets/async-return-types/async-returns2a.cs" id="AwaitTask":::

## <a name="tasktresult-return-type"></a><span data-ttu-id="0f7b2-132">Task\<TResult\> の戻り値の型</span><span class="sxs-lookup"><span data-stu-id="0f7b2-132">Task\<TResult\> return type</span></span>

<span data-ttu-id="0f7b2-133">戻り値の型 <xref:System.Threading.Tasks.Task%601> は、オペランドが `TResult` である [return](../../../language-reference/keywords/return.md) ステートメントを含む非同期メソッドに使用されます。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-133">The <xref:System.Threading.Tasks.Task%601> return type is used for an async method that contains a [return](../../../language-reference/keywords/return.md) statement in which the operand is `TResult`.</span></span>

<span data-ttu-id="0f7b2-134">次の例の `GetLeisureHoursAsync` メソッドには、整数を返す `return` ステートメントが含まれています。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-134">In the following example, the `GetLeisureHoursAsync` method contains a `return` statement that returns an integer.</span></span> <span data-ttu-id="0f7b2-135">そのため、メソッド宣言では、戻り値の型を `Task<int>` と指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-135">Therefore, the method declaration must specify a return type of `Task<int>`.</span></span> <span data-ttu-id="0f7b2-136">非同期メソッド <xref:System.Threading.Tasks.Task.FromResult%2A> は、<xref:System.DateTime.DayOfWeek> を返す操作に対するプレースホルダーです。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-136">The <xref:System.Threading.Tasks.Task.FromResult%2A> async method is a placeholder for an operation that returns a <xref:System.DateTime.DayOfWeek>.</span></span>

:::code language="csharp" source="snippets/async-return-types/async-returns1.cs" id="LeisureHours":::

<span data-ttu-id="0f7b2-137">`GetLeisureHoursAsync` が `ShowTodaysInfo` メソッドの await 式の中から呼び出されると、await 式は `GetLeisureHours` メソッドから返されるタスクに格納されている整数値 (`leisureHours` の値) を取得します。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-137">When `GetLeisureHoursAsync` is called from within an await expression in the `ShowTodaysInfo` method, the await expression retrieves the integer value (the value of `leisureHours`) that's stored in the task returned by the `GetLeisureHours` method.</span></span> <span data-ttu-id="0f7b2-138">await 式の詳細については、「[await](../../../language-reference/operators/await.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-138">For more information about await expressions, see [await](../../../language-reference/operators/await.md).</span></span>

<span data-ttu-id="0f7b2-139">次のコードが示すように、`GetLeisureHoursAsync` への呼び出しを `await` のアプリケーションから分離すると、`await` で `Task<T>` から結果を取得する方法をよりよく理解できます。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-139">You can better understand how `await` retrieves the result from a `Task<T>` by separating the call to `GetLeisureHoursAsync` from the application of `await`, as the following code shows.</span></span> <span data-ttu-id="0f7b2-140">メソッドの宣言から予想されるように、直ちに待機しない `GetLeisureHoursAsync` メソッドの呼び出しは、`Task<int>` を返します。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-140">A call to method `GetLeisureHoursAsync` that isn't immediately awaited returns a `Task<int>`, as you would expect from the declaration of the method.</span></span> <span data-ttu-id="0f7b2-141">タスクは、この例の `getLeisureHoursTask` 変数に割り当てられます。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-141">The task is assigned to the `getLeisureHoursTask` variable in the example.</span></span> <span data-ttu-id="0f7b2-142">`getLeisureHoursTask` は <xref:System.Threading.Tasks.Task%601> であるため、<xref:System.Threading.Tasks.Task%601.Result> 型の `TResult` プロパティが含まれています。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-142">Because `getLeisureHoursTask` is a <xref:System.Threading.Tasks.Task%601>, it contains a <xref:System.Threading.Tasks.Task%601.Result> property of type `TResult`.</span></span> <span data-ttu-id="0f7b2-143">この場合、`TResult` は整数型を表します。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-143">In this case, `TResult` represents an integer type.</span></span> <span data-ttu-id="0f7b2-144">`await` が `getLeisureHoursTask` に適用されると、`getLeisureHoursTask` の <xref:System.Threading.Tasks.Task%601.Result%2A> プロパティの内容が await 式の評価となります。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-144">When `await` is applied to `getLeisureHoursTask`, the await expression evaluates to the contents of the <xref:System.Threading.Tasks.Task%601.Result%2A> property of `getLeisureHoursTask`.</span></span> <span data-ttu-id="0f7b2-145">この値は `ret` 変数に割り当てられます。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-145">The value is assigned to the `ret` variable.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="0f7b2-146"><xref:System.Threading.Tasks.Task%601.Result%2A> プロパティは Blocking プロパティです。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-146">The <xref:System.Threading.Tasks.Task%601.Result%2A> property is a blocking property.</span></span> <span data-ttu-id="0f7b2-147">タスクが終了する前にアクセスしようとすると、現在アクティブなスレッドは、タスクが完了して値が使用可能になるまで、ブロックされます。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-147">If you try to access it before its task is finished, the thread that's currently active is blocked until the task completes and the value is available.</span></span> <span data-ttu-id="0f7b2-148">多くの場合、プロパティに直接アクセスする代わりに、`await` を使用して値にアクセスする必要があります。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-148">In most cases, you should access the value by using `await` instead of accessing the property directly.</span></span>
>
> <span data-ttu-id="0f7b2-149">前の例では、アプリケーションが終了する前に `Main` メソッドで `message` を出力できるように、<xref:System.Threading.Tasks.Task%601.Result%2A> プロパティの値を取得してメイン スレッドをブロックしました。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-149">The previous example retrieved the value of the <xref:System.Threading.Tasks.Task%601.Result%2A> property to block the main thread so that the `Main` method could print the `message` to the console before the application ended.</span></span>

:::code language="csharp" source="snippets/async-return-types/async-returns1a.cs" id="StoreTask":::

## <a name="void-return-type"></a><span data-ttu-id="0f7b2-150">Void の戻り値の型</span><span class="sxs-lookup"><span data-stu-id="0f7b2-150">Void return type</span></span>

<span data-ttu-id="0f7b2-151">`void` 戻り値の型は、`void` 戻り値の型が必要な非同期イベント ハンドラーで使用します。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-151">You use the `void` return type in asynchronous event handlers, which require a `void` return type.</span></span> <span data-ttu-id="0f7b2-152">値を返さないイベント ハンドラー以外のメソッドについては、<xref:System.Threading.Tasks.Task> を返す必要があります。これは、`void` を返す非同期メソッドを待機できないためです。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-152">For methods other than event handlers that don't return a value, you should return a <xref:System.Threading.Tasks.Task> instead, because an async method that returns `void` can't be awaited.</span></span> <span data-ttu-id="0f7b2-153">このようなメソッドの呼び出し元は、呼び出された非同期メソッドが完了するまで待機せずに、完了するまで続行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-153">Any caller of such a method must continue to completion without waiting for the called async method to finish.</span></span> <span data-ttu-id="0f7b2-154">呼び出し元は、非同期メソッドによって生成される値や例外から独立している必要があります。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-154">The caller must be independent of any values or exceptions that the async method generates.</span></span>

<span data-ttu-id="0f7b2-155">void を返す非同期メソッドの呼び出し元は、メソッドからスローされる例外をキャッチすることはできません。そのようなハンドルされない例外によって、アプリケーションが失敗する可能性が高くなります。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-155">The caller of a void-returning async method can't catch exceptions thrown from the method, and such unhandled exceptions are likely to cause your application to fail.</span></span> <span data-ttu-id="0f7b2-156"><xref:System.Threading.Tasks.Task> または <xref:System.Threading.Tasks.Task%601> を返すメソッドから例外がスローされた場合、例外は返されたタスクに格納されます。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-156">If a method that returns a <xref:System.Threading.Tasks.Task> or <xref:System.Threading.Tasks.Task%601> throws an exception, the exception is stored in the returned task.</span></span> <span data-ttu-id="0f7b2-157">タスクを待機しているときは、例外が再スローされます。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-157">The exception is rethrown when the task is awaited.</span></span> <span data-ttu-id="0f7b2-158">したがって、例外を生成する場合がある非同期メソッドは <xref:System.Threading.Tasks.Task> または <xref:System.Threading.Tasks.Task%601> の戻り値の型を持つこと、またメソッドの呼び出しが待機することを確認します。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-158">Therefore, make sure that any async method that can produce an exception has a return type of <xref:System.Threading.Tasks.Task> or <xref:System.Threading.Tasks.Task%601> and that calls to the method are awaited.</span></span>

<span data-ttu-id="0f7b2-159">非同期メソッドで例外をキャッチする方法の詳細については、「[try-catch](../../../language-reference/keywords/try-catch.md)」の記事の「[非同期メソッドの例外](../../../language-reference/keywords/try-catch.md#exceptions-in-async-methods)」セクションを参照してください。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-159">For more information about how to catch exceptions in async methods, see the [Exceptions in async methods](../../../language-reference/keywords/try-catch.md#exceptions-in-async-methods) section of the [try-catch](../../../language-reference/keywords/try-catch.md) article.</span></span>

<span data-ttu-id="0f7b2-160">次の例では、非同期イベント ハンドラーの動作を示します。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-160">The following example shows the behavior of an async event handler.</span></span> <span data-ttu-id="0f7b2-161">コード例では、非同期イベント ハンドラーが終了したとき、その非同期イベント ハンドラーからメイン スレッドに通知が送られる必要があります。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-161">In the example code, an async event handler must let the main thread know when it finishes.</span></span> <span data-ttu-id="0f7b2-162">このため、メイン スレッドでは、非同期イベント ハンドラーの終了を待ってから、プログラムを終了することができます。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-162">Then the main thread can wait for an async event handler to complete before exiting the program.</span></span>

:::code language="csharp" source="snippets/async-return-types/async-returns3.cs":::

## <a name="generalized-async-return-types-and-valuetasktresult"></a><span data-ttu-id="0f7b2-163">一般化された async の戻り値の型と ValueTask\<TResult\></span><span class="sxs-lookup"><span data-stu-id="0f7b2-163">Generalized async return types and ValueTask\<TResult\></span></span>

<span data-ttu-id="0f7b2-164">C# 7.0 以降、非同期メソッドでは、*awaiter 型* のインスタンスを返すアクセス可能な `GetAwaiter` メソッドがある任意の型を返すことができます。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-164">Starting with C# 7.0, an async method can return any type that has an accessible `GetAwaiter` method that returns an instance of an *awaiter type*.</span></span> <span data-ttu-id="0f7b2-165">さらに、`GetAwaiter` メソッドから返される型には <xref:System.Runtime.CompilerServices.AsyncMethodBuilderAttribute?displayProperty=nameWithType> 属性が必要です。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-165">In addition, the type returned from the `GetAwaiter` method must have the <xref:System.Runtime.CompilerServices.AsyncMethodBuilderAttribute?displayProperty=nameWithType> attribute.</span></span> <span data-ttu-id="0f7b2-166">詳細については、[task に似た戻り値の型](../../../../../_csharplang/proposals/csharp-7.0/task-types.md)の機能仕様を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-166">You can learn more in the feature spec for [Task like return types](../../../../../_csharplang/proposals/csharp-7.0/task-types.md).</span></span>

<span data-ttu-id="0f7b2-167">この機能は、`await` のオペランドの要件を記述する[待機可能な式](../../../../../_csharplang/spec/expressions.md#awaitable-expressions)を補完するものです。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-167">This feature is the complement to [awaitable expressions](../../../../../_csharplang/spec/expressions.md#awaitable-expressions), which describes the requirements for the operand of `await`.</span></span> <span data-ttu-id="0f7b2-168">一般化された非同期の戻り値の型により、コンパイラではさまざまな型を返す `async` メソッドを生成できます。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-168">Generalized async return types enable the compiler to generate `async` methods that return different types.</span></span> <span data-ttu-id="0f7b2-169">一般化された非同期の戻り値の型により、.NET ライブラリのパフォーマンスの向上が可能になりました。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-169">Generalized async return types enabled performance improvements in the .NET libraries.</span></span> <span data-ttu-id="0f7b2-170"><xref:System.Threading.Tasks.Task> および <xref:System.Threading.Tasks.Task%601> は参照型であるため、特に厳密なループ処理で割り当てが発生すると、パフォーマンスが重要なパスのメモリ割り当てが、パフォーマンスに悪影響を及ぼすことがあります。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-170">Because <xref:System.Threading.Tasks.Task> and <xref:System.Threading.Tasks.Task%601> are reference types, memory allocation in performance-critical paths, particularly when allocations occur in tight loops, can adversely affect performance.</span></span> <span data-ttu-id="0f7b2-171">一般化された戻り値の型のサポートにより、参照型ではなく、軽量な値の型を返すことができ、追加のメモリ割り当てを回避することが可能です。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-171">Support for generalized return types means that you can return a lightweight value type instead of a reference type to avoid additional memory allocations.</span></span>

<span data-ttu-id="0f7b2-172">.NET には、一般化されたタスク戻り値の軽量な実装として、<xref:System.Threading.Tasks.ValueTask%601?displayProperty=nameWithType> 構造が用意されています。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-172">.NET provides the <xref:System.Threading.Tasks.ValueTask%601?displayProperty=nameWithType> structure as a lightweight implementation of a generalized task-returning value.</span></span> <span data-ttu-id="0f7b2-173"><xref:System.Threading.Tasks.ValueTask%601?displayProperty=nameWithType> 型を使用するには、`System.Threading.Tasks.Extensions` NuGet パッケージをプロジェクトに追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-173">To use the <xref:System.Threading.Tasks.ValueTask%601?displayProperty=nameWithType> type, you must add the `System.Threading.Tasks.Extensions` NuGet package to your project.</span></span> <span data-ttu-id="0f7b2-174">次の例では、<xref:System.Threading.Tasks.ValueTask%601> 構造を使用して、2 つのさいころを転がしたときの値を取得します。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-174">The following example uses the <xref:System.Threading.Tasks.ValueTask%601> structure to retrieve the value of two dice rolls.</span></span>

:::code language="csharp" source="snippets/async-return-types/async-valuetask.cs":::

<span data-ttu-id="0f7b2-175">一般化された非同期の戻り値の型を記述することは高度なシナリオであり、きわめて特殊な環境での使用を対象としています。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-175">Writing a generalized async return type is an advanced scenario, and is targeted for use in very specific environments.</span></span> <span data-ttu-id="0f7b2-176">代わりに、非同期コードのほとんどのシナリオに対応する `Task`、`Task<T>`、`ValueTask<T>` 型の使用を検討してください。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-176">Consider using the `Task`, `Task<T>` and `ValueTask<T>` types instead, which cover most scenarios for asynchronous code.</span></span>

## <a name="async-streams-with-iasyncenumerablet"></a><span data-ttu-id="0f7b2-177">IAsyncEnumerable\<T\> を使用する非同期ストリーム</span><span class="sxs-lookup"><span data-stu-id="0f7b2-177">Async streams with IAsyncEnumerable\<T\></span></span>

<span data-ttu-id="0f7b2-178">C# 8.0 以降は、非同期メソッドから <xref:System.Collections.Generic.IAsyncEnumerable%601> で表される *非同期ストリーム* が返される場合があります。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-178">Starting with C# 8.0, an async method may return an *async stream*, represented by <xref:System.Collections.Generic.IAsyncEnumerable%601>.</span></span> <span data-ttu-id="0f7b2-179">非同期ストリームを使用すると、非同期呼び出しが繰り返される要素がチャンクで生成されるときに、ストリームから読み取られた項目を列挙できます。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-179">An async stream provides a way to enumerate items read from a stream when elements are generated in chunks with repeated asynchronous calls.</span></span> <span data-ttu-id="0f7b2-180">次の例は、非同期ストリームを生成する非同期メソッドを示しています。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-180">The following example shows an async method that generates an async stream:</span></span>

:::code language="csharp" source="snippets/async-return-types/AsyncStreams.cs" id="GenerateAsyncStream":::

<span data-ttu-id="0f7b2-181">前の例では、文字列から非同期に行を読み取ります。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-181">The preceding example reads lines from a string asynchronously.</span></span> <span data-ttu-id="0f7b2-182">各行が読み取られると、コードによって文字列内の各単語が列挙されます。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-182">Once each line is read, the code enumerates each word in the string.</span></span> <span data-ttu-id="0f7b2-183">呼び出し元では、`await foreach` ステートメントを使用して各単語を列挙します。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-183">Callers would enumerate each word using the `await foreach` statement.</span></span> <span data-ttu-id="0f7b2-184">このメソッドを使用すると、ソース文字列から次の行を非同期的に読み取る必要があるときに待機できます。</span><span class="sxs-lookup"><span data-stu-id="0f7b2-184">The method awaits when it needs to asynchronously read the next line from the source string.</span></span>

## <a name="see-also"></a><span data-ttu-id="0f7b2-185">関連項目</span><span class="sxs-lookup"><span data-stu-id="0f7b2-185">See also</span></span>

- <xref:System.Threading.Tasks.Task.FromResult%2A>
- [<span data-ttu-id="0f7b2-186">完了時の非同期タスクの処理</span><span class="sxs-lookup"><span data-stu-id="0f7b2-186">Process asynchronous tasks as they complete</span></span>](start-multiple-async-tasks-and-process-them-as-they-complete.md)
- [<span data-ttu-id="0f7b2-187">Async および Await を使用した非同期プログラミング (C#)</span><span class="sxs-lookup"><span data-stu-id="0f7b2-187">Asynchronous programming with async and await (C#)</span></span>](index.md)
- [<span data-ttu-id="0f7b2-188">async</span><span class="sxs-lookup"><span data-stu-id="0f7b2-188">async</span></span>](../../../language-reference/keywords/async.md)
- [<span data-ttu-id="0f7b2-189">await</span><span class="sxs-lookup"><span data-stu-id="0f7b2-189">await</span></span>](../../../language-reference/operators/await.md)
