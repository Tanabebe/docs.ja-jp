---
title: C# で既定のインターフェイス メソッドを使用してインターフェイスを安全に更新する
description: この高度なチュートリアルでは、既存のインターフェイスを実装するすべてのクラスと構造体を損なうことなく、そのインターフェイスの定義に新しい機能を安全に追加する方法について説明します。
ms.date: 05/06/2019
ms.technlogy: csharp-advanced-concepts
ms.custom: mvc
ms.openlocfilehash: 43af25cee765ba18543b0c7bfe0069542a90e0e5
ms.sourcegitcommit: c7f0beaa2bd66ebca86362ca17d673f7e8256ca6
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/23/2021
ms.locfileid: "104878907"
---
# <a name="tutorial-update-interfaces-with-default-interface-methods-in-c-80"></a><span data-ttu-id="d5514-103">チュートリアル: C# 8.0 で既定のインターフェイス メソッドを使用してインターフェイスを更新する</span><span class="sxs-lookup"><span data-stu-id="d5514-103">Tutorial: Update interfaces with default interface methods in C# 8.0</span></span>

<span data-ttu-id="d5514-104">.NET Core 3.0 上の C# 8.0 以降では、インターフェイスのメンバーを宣言するときに実装を定義できます。</span><span class="sxs-lookup"><span data-stu-id="d5514-104">Beginning with C# 8.0 on .NET Core 3.0, you can define an implementation when you declare a member of an interface.</span></span> <span data-ttu-id="d5514-105">最も一般的なシナリオは、数え切れないほどのクライアントから既にリリースされ、使用されているインターフェイスにメンバーを安全に追加することです。</span><span class="sxs-lookup"><span data-stu-id="d5514-105">The most common scenario is to safely add members to an interface already released and used by innumerable clients.</span></span>

<span data-ttu-id="d5514-106">このチュートリアルでは、次の作業を行う方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="d5514-106">In this tutorial, you'll learn how to:</span></span>

> [!div class="checklist"]
>
> * <span data-ttu-id="d5514-107">実装を含むメソッドを追加して、インターフェイスを安全に拡張します。</span><span class="sxs-lookup"><span data-stu-id="d5514-107">Extend interfaces safely by adding methods with implementations.</span></span>
> * <span data-ttu-id="d5514-108">パラメーター化された実装を作成して、柔軟性を高めます。</span><span class="sxs-lookup"><span data-stu-id="d5514-108">Create parameterized implementations to provide greater flexibility.</span></span>
> * <span data-ttu-id="d5514-109">実装者がオーバーライドの形でより具体的な実装を提供できるようにします。</span><span class="sxs-lookup"><span data-stu-id="d5514-109">Enable implementers to provide a more specific implementation in the form of an override.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="d5514-110">必須コンポーネント</span><span class="sxs-lookup"><span data-stu-id="d5514-110">Prerequisites</span></span>

<span data-ttu-id="d5514-111">お使いのコンピューターを、.NET Core が実行されるように設定する必要があります。C# 8.0 コンパイラも実行されるようにします。</span><span class="sxs-lookup"><span data-stu-id="d5514-111">You’ll need to set up your machine to run .NET Core, including the C# 8.0 compiler.</span></span> <span data-ttu-id="d5514-112">C# 8.0 コンパイラは [Visual Studio 2019 バージョン 16.3](https://visualstudio.microsoft.com/downloads/?utm_medium=microsoft&utm_source=docs.microsoft.com&utm_campaign=inline+link&utm_content=download+vs2019) または [.NET Core 3.0 SDK](https://dotnet.microsoft.com/download) 以降で使用できます。</span><span class="sxs-lookup"><span data-stu-id="d5514-112">The C# 8.0 compiler is available starting with [Visual Studio 2019 version 16.3](https://visualstudio.microsoft.com/downloads/?utm_medium=microsoft&utm_source=docs.microsoft.com&utm_campaign=inline+link&utm_content=download+vs2019) or the [.NET Core 3.0 SDK](https://dotnet.microsoft.com/download).</span></span>

## <a name="scenario-overview"></a><span data-ttu-id="d5514-113">シナリオの概要</span><span class="sxs-lookup"><span data-stu-id="d5514-113">Scenario overview</span></span>

<span data-ttu-id="d5514-114">このチュートリアルは、カスタマー リレーションシップ ライブラリのバージョン 1 から始まります。</span><span class="sxs-lookup"><span data-stu-id="d5514-114">This tutorial starts with version 1 of a customer relationship library.</span></span> <span data-ttu-id="d5514-115">[GitHub 上の サンプル リポジトリ](https://github.com/dotnet/samples/tree/main/csharp/tutorials/default-interface-members-versions/starter/customer-relationship)でスターター アプリケーションを入手できます。</span><span class="sxs-lookup"><span data-stu-id="d5514-115">You can get the starter application on our [samples repo on GitHub](https://github.com/dotnet/samples/tree/main/csharp/tutorials/default-interface-members-versions/starter/customer-relationship).</span></span> <span data-ttu-id="d5514-116">このライブラリを構築した会社の目的は、既存のアプリケーションを使用している顧客がライブラリを採用することでした。</span><span class="sxs-lookup"><span data-stu-id="d5514-116">The company that built this library intended customers with existing applications to adopt their library.</span></span> <span data-ttu-id="d5514-117">ライブラリのユーザーが実装できる最小限のインターフェイス定義が用意されました。</span><span class="sxs-lookup"><span data-stu-id="d5514-117">They provided minimal interface definitions for users of their library to implement.</span></span> <span data-ttu-id="d5514-118">顧客向けのインターフェイス定義は次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="d5514-118">Here's the interface definition for a customer:</span></span>

[!code-csharp[InitialCustomerInterface](~/samples/snippets/csharp/tutorials/default-interface-members-versions/starter/customer-relationship/ICustomer.cs?name=SnippetICustomerVersion1)]

<span data-ttu-id="d5514-119">注文を表す 2 つ目のインターフェイスを定義しました。</span><span class="sxs-lookup"><span data-stu-id="d5514-119">They defined a second interface that represents an order:</span></span>

[!code-csharp[InitialOrderInterface](~/samples/snippets/csharp/tutorials/default-interface-members-versions/starter/customer-relationship/IOrder.cs?name=SnippetIorderVersion1)]

<span data-ttu-id="d5514-120">チームは、これらのインターフェイスからユーザー向けのライブラリを構築し、顧客にとってより良いエクスペリエンスを作り出すことができました。</span><span class="sxs-lookup"><span data-stu-id="d5514-120">From those interfaces, the team could build a library for their users to create a better experience for their customers.</span></span> <span data-ttu-id="d5514-121">目標は、既存の顧客との関係を深め、新しい顧客との関係を改善することでした。</span><span class="sxs-lookup"><span data-stu-id="d5514-121">Their goal was to create a deeper relationship with existing customers and improve their relationships with new customers.</span></span>

<span data-ttu-id="d5514-122">次回のリリースのためにライブラリをアップグレードする時期になりました。</span><span class="sxs-lookup"><span data-stu-id="d5514-122">Now, it's time to upgrade the library for the next release.</span></span> <span data-ttu-id="d5514-123">求められている機能の 1 つは、注文数が多い顧客向けにロイヤルティ割引を有効にすることです。</span><span class="sxs-lookup"><span data-stu-id="d5514-123">One of the requested features enables a loyalty discount for customers that have lots of orders.</span></span> <span data-ttu-id="d5514-124">この新しいロイヤルティ割引は、顧客が注文するたびに適用されます。</span><span class="sxs-lookup"><span data-stu-id="d5514-124">This new loyalty discount gets applied whenever a customer makes an order.</span></span> <span data-ttu-id="d5514-125">この特定の割引は、各顧客のプロパティです。</span><span class="sxs-lookup"><span data-stu-id="d5514-125">The specific discount is a property of each individual customer.</span></span> <span data-ttu-id="d5514-126">`ICustomer` の各実装で、ロイヤルティ割引に対して異なるルールを設定できます。</span><span class="sxs-lookup"><span data-stu-id="d5514-126">Each implementation of `ICustomer` can set different rules for the loyalty discount.</span></span>

<span data-ttu-id="d5514-127">この機能を追加する最も自然な方法は、ロイヤルティ割引を適用するメソッドを使用して `ICustomer` インターフェイスを拡張することです。</span><span class="sxs-lookup"><span data-stu-id="d5514-127">The most natural way to add this functionality is to enhance the `ICustomer` interface with a method to apply any loyalty discount.</span></span> <span data-ttu-id="d5514-128">この設計の提案から、経験豊富な開発者の間で次のような懸念が起こりました。「リリース済みのインターフェイスは変更できません。</span><span class="sxs-lookup"><span data-stu-id="d5514-128">This design suggestion caused concern among experienced developers: "Interfaces are immutable once they've been released!</span></span> <span data-ttu-id="d5514-129">これは破壊的変更です」</span><span class="sxs-lookup"><span data-stu-id="d5514-129">This is a breaking change!"</span></span> <span data-ttu-id="d5514-130">C# 8.0 では、インターフェイスをアップグレードするための "*既定のインターフェイス実装*" が追加されました。</span><span class="sxs-lookup"><span data-stu-id="d5514-130">C# 8.0 adds *default interface implementations* for upgrading interfaces.</span></span> <span data-ttu-id="d5514-131">ライブラリ作成者はインターフェイスに新しいメンバーを追加し、それらのメンバーに既定の実装を指定することができます。</span><span class="sxs-lookup"><span data-stu-id="d5514-131">The library authors can add new members to the interface and provide a default implementation for those members.</span></span>

<span data-ttu-id="d5514-132">既定のインターフェイス実装を使用すると、開発者がインターフェイスをアップグレードできるだけでなく、すべての実装者がその実装をオーバーライドできるようになります。</span><span class="sxs-lookup"><span data-stu-id="d5514-132">Default interface implementations enable developers to upgrade an interface while still enabling any implementors to override that implementation.</span></span> <span data-ttu-id="d5514-133">ライブラリのユーザーは、非破壊的変更として既定の実装を受け入れることができます。</span><span class="sxs-lookup"><span data-stu-id="d5514-133">Users of the library can accept the default implementation as a non-breaking change.</span></span> <span data-ttu-id="d5514-134">ビジネス ルールが異なる場合は、オーバーライドできます。</span><span class="sxs-lookup"><span data-stu-id="d5514-134">If their business rules are different, they can override.</span></span>

## <a name="upgrade-with-default-interface-methods"></a><span data-ttu-id="d5514-135">既定のインターフェイス メソッドを使用してアップグレードする</span><span class="sxs-lookup"><span data-stu-id="d5514-135">Upgrade with default interface methods</span></span>

<span data-ttu-id="d5514-136">チームは、最も可能性の高い既定の実装、つまり顧客に対するロイヤルティ割引について合意しました。</span><span class="sxs-lookup"><span data-stu-id="d5514-136">The team agreed on the most likely default implementation: a loyalty discount for customers.</span></span>

<span data-ttu-id="d5514-137">アップグレードでは、2 つのプロパティを設定する機能を提供する必要があります。割引の対象となるために必要な注文数と、割引の割合です。</span><span class="sxs-lookup"><span data-stu-id="d5514-137">The upgrade should provide the functionality to set two properties: the number of orders needed to be eligible for the discount, and the percentage of the discount.</span></span> <span data-ttu-id="d5514-138">これは、既定のインターフェイス メソッドに最適なシナリオです。</span><span class="sxs-lookup"><span data-stu-id="d5514-138">This makes it a perfect scenario for default interface methods.</span></span> <span data-ttu-id="d5514-139">`ICustomer` インターフェイスにメソッドを追加し、最も確実な実装を提供することができます。</span><span class="sxs-lookup"><span data-stu-id="d5514-139">You can add a method to the `ICustomer` interface, and provide the most likely implementation.</span></span> <span data-ttu-id="d5514-140">すべての既存の実装とすべての新しい実装では、既定の実装を使用することも、独自の実装を提供することもできます。</span><span class="sxs-lookup"><span data-stu-id="d5514-140">All existing, and any new implementations can use the default implementation, or provide their own.</span></span>

<span data-ttu-id="d5514-141">まず、メソッドの本体を含め、インターフェイスに新しいメソッドを追加します。</span><span class="sxs-lookup"><span data-stu-id="d5514-141">First, add the new method to the interface, including the body of the method:</span></span>

[!code-csharp[InitialOrderInterface](~/samples/snippets/csharp/tutorials/default-interface-members-versions/finished/customer-relationship/ICustomer.cs?name=SnippetLoyaltyDiscountVersionOne)]

<span data-ttu-id="d5514-142">ライブラリ作成者は、実装を確認する最初のテストを作成しました。</span><span class="sxs-lookup"><span data-stu-id="d5514-142">The library author wrote a first test to check the implementation:</span></span>

[!code-csharp[TestDefaultImplementation](~/samples/snippets/csharp/tutorials/default-interface-members-versions/finished/customer-relationship/Program.cs?name=SnippetTestDefaultImplementation)]

<span data-ttu-id="d5514-143">テストの次の部分に注目してください。</span><span class="sxs-lookup"><span data-stu-id="d5514-143">Notice the following portion of the test:</span></span>

[!code-csharp[TestDefaultImplementation](~/samples/snippets/csharp/tutorials/default-interface-members-versions/finished/customer-relationship/Program.cs?name=SnippetHighlightCast)]

<span data-ttu-id="d5514-144">`SampleCustomer` から `ICustomer` へのキャストは必須です。</span><span class="sxs-lookup"><span data-stu-id="d5514-144">That cast from `SampleCustomer` to `ICustomer` is necessary.</span></span> <span data-ttu-id="d5514-145">`SampleCustomer` クラスから `ComputeLoyaltyDiscount` の実装を提供する必要はありません。これは `ICustomer` インターフェイスによって提供されます。</span><span class="sxs-lookup"><span data-stu-id="d5514-145">The `SampleCustomer` class doesn't need to provide an implementation for `ComputeLoyaltyDiscount`; that's provided by the `ICustomer` interface.</span></span> <span data-ttu-id="d5514-146">ただし、`SampleCustomer` クラスはそのインターフェイスからメンバーを継承しません。</span><span class="sxs-lookup"><span data-stu-id="d5514-146">However, the `SampleCustomer` class doesn't inherit members from its interfaces.</span></span> <span data-ttu-id="d5514-147">そのルールは変わっていません。</span><span class="sxs-lookup"><span data-stu-id="d5514-147">That rule hasn't changed.</span></span> <span data-ttu-id="d5514-148">インターフェイスで宣言および実装されているメソッドを呼び出すには、変数をインターフェイスの型 (この例では `ICustomer`) 似する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d5514-148">In order to call any method declared and implemented in the interface, the variable must be the type of the interface, `ICustomer` in this example.</span></span>

## <a name="provide-parameterization"></a><span data-ttu-id="d5514-149">パラメーター化を提供する</span><span class="sxs-lookup"><span data-stu-id="d5514-149">Provide parameterization</span></span>

<span data-ttu-id="d5514-150">なかなかのスタートです。</span><span class="sxs-lookup"><span data-stu-id="d5514-150">That's a good start.</span></span> <span data-ttu-id="d5514-151">ただし、既定の実装は制限が厳しすぎます。</span><span class="sxs-lookup"><span data-stu-id="d5514-151">But, the default implementation is too restrictive.</span></span> <span data-ttu-id="d5514-152">このシステムの多くの利用者は、異なる購入数のしきい値、異なる長さのメンバーシップ、または異なる割引率を選択する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="d5514-152">Many consumers of this system may choose different thresholds for number of purchases, a different length of membership, or a different percentage discount.</span></span> <span data-ttu-id="d5514-153">これらのパラメーターを設定する方法を用意することで、より多くの顧客とって優れたアップグレード エクスペリエンスを提供できます。</span><span class="sxs-lookup"><span data-stu-id="d5514-153">You can provide a better upgrade experience for more customers by providing a way to set those parameters.</span></span> <span data-ttu-id="d5514-154">既定の実装を制御するこれら 3 つのパラメーターを設定する静的メソッドを追加しましょう。</span><span class="sxs-lookup"><span data-stu-id="d5514-154">Let's add a static method that sets those three parameters controlling the default implementation:</span></span>

[!code-csharp[VersionTwoImplementation](~/samples/snippets/csharp/tutorials/default-interface-members-versions/finished/customer-relationship/ICustomer.cs?name=SnippetLoyaltyDiscountVersionTwo)]

<span data-ttu-id="d5514-155">このわずかなコード フラグメントには、新しい言語機能が多数見られます。</span><span class="sxs-lookup"><span data-stu-id="d5514-155">There are many new language capabilities shown in that small code fragment.</span></span> <span data-ttu-id="d5514-156">インターフェイスには、フィールドやメソッドなどの静的メンバーを含めることができるようになりました。</span><span class="sxs-lookup"><span data-stu-id="d5514-156">Interfaces can now include static members, including fields and methods.</span></span> <span data-ttu-id="d5514-157">さまざまなアクセス修飾子も使用できます。</span><span class="sxs-lookup"><span data-stu-id="d5514-157">Different access modifiers are also enabled.</span></span> <span data-ttu-id="d5514-158">追加のフィールドはプライベートであり、新しいメソッドはパブリックです。</span><span class="sxs-lookup"><span data-stu-id="d5514-158">The additional fields are private, the new method is public.</span></span> <span data-ttu-id="d5514-159">どの修飾子もインターフェイス メンバーに使用できます。</span><span class="sxs-lookup"><span data-stu-id="d5514-159">Any of the modifiers are allowed on interface members.</span></span>

<span data-ttu-id="d5514-160">ロイヤルティ割引の計算に一般的な数式を使用する (ただしパラメーターは異なる) アプリケーションでは、カスタム実装を用意する必要がありません。静的メソッドを介して引数を設定できます。</span><span class="sxs-lookup"><span data-stu-id="d5514-160">Applications that use the general formula for computing the loyalty discount, but different parameters, don't need to provide a custom implementation; they can set the arguments through a static method.</span></span> <span data-ttu-id="d5514-161">たとえば、次のコードでは、メンバーシップが 1 か月を超えるすべての顧客に報酬を与える "顧客感謝" を設定します。</span><span class="sxs-lookup"><span data-stu-id="d5514-161">For example, the following code sets a "customer appreciation" that rewards any customer with more than one month's membership:</span></span>

[!code-csharp[SetLoyaltyThresholds](~/samples/snippets/csharp/tutorials/default-interface-members-versions/finished/customer-relationship/Program.cs?name=SnippetSetLoyaltyThresholds)]

## <a name="extend-the-default-implementation"></a><span data-ttu-id="d5514-162">既定の実装を拡張する</span><span class="sxs-lookup"><span data-stu-id="d5514-162">Extend the default implementation</span></span>

<span data-ttu-id="d5514-163">これまでに追加したコードでは、ユーザーが既定の実装のようなものを希望しているシナリオ、または関係のない一連のルールを指定するシナリオに便利な実装を提供しました。</span><span class="sxs-lookup"><span data-stu-id="d5514-163">The code you've added so far has provided a convenient implementation for those scenarios where users want something like the default implementation, or to provide an unrelated set of rules.</span></span> <span data-ttu-id="d5514-164">最後の機能として、コードを少しリファクターして、ユーザーが既定の実装を基に構築したくなるようなシナリオに対応しましょう。</span><span class="sxs-lookup"><span data-stu-id="d5514-164">For a final feature, let's refactor the code a bit to enable scenarios where users may want to build on the default implementation.</span></span>

<span data-ttu-id="d5514-165">新規顧客を引き付けたいスタートアップ企業があるとします。</span><span class="sxs-lookup"><span data-stu-id="d5514-165">Consider a startup that wants to attract new customers.</span></span> <span data-ttu-id="d5514-166">新規顧客の最初の注文には 50% 割引が提供されます。</span><span class="sxs-lookup"><span data-stu-id="d5514-166">They offer a 50% discount off a new customer's first order.</span></span> <span data-ttu-id="d5514-167">それ以外の場合、既存の顧客は標準の割引を受けます。</span><span class="sxs-lookup"><span data-stu-id="d5514-167">Otherwise, existing customers get the standard discount.</span></span> <span data-ttu-id="d5514-168">このインターフェイスを実装するすべてのクラスが実装内でコードを再利用できるように、ライブラリ作成者は既定の実装を `protected static` メソッドに移行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d5514-168">The library author needs to move the default implementation into a `protected static` method so that any class implementing this interface can reuse the code in their implementation.</span></span> <span data-ttu-id="d5514-169">インターフェイス メンバーの既定の実装では、この共有メソッドも呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="d5514-169">The default implementation of the interface member calls this shared method as well:</span></span>

[!code-csharp[VersionTwoImplementation](~/samples/snippets/csharp/tutorials/default-interface-members-versions/finished/customer-relationship/ICustomer.cs?name=SnippetFinalVersion)]

<span data-ttu-id="d5514-170">このインターフェイスを実装するクラスの実装では、オーバーライドによって静的ヘルパー メソッドを呼び出し、そのロジックを拡張して "新規顧客" の割引を提供することができます。</span><span class="sxs-lookup"><span data-stu-id="d5514-170">In an implementation of a class that implements this interface, the override can call the static helper method, and extend that logic to provide the "new customer" discount:</span></span>

[!code-csharp[VersionTwoImplementation](~/samples/snippets/csharp/tutorials/default-interface-members-versions/finished/customer-relationship/SampleCustomer.cs?name=SnippetOverrideAndExtend)]

<span data-ttu-id="d5514-171">[GitHub 上の サンプル リポジトリ](https://github.com/dotnet/samples/tree/main/csharp/tutorials/default-interface-members-versions/finished/customer-relationship)で完成したコード全体を確認できます。</span><span class="sxs-lookup"><span data-stu-id="d5514-171">You can see the entire finished code in our [samples repo on GitHub](https://github.com/dotnet/samples/tree/main/csharp/tutorials/default-interface-members-versions/finished/customer-relationship).</span></span> <span data-ttu-id="d5514-172">[GitHub 上の サンプル リポジトリ](https://github.com/dotnet/samples/tree/main/csharp/tutorials/default-interface-members-versions/starter/customer-relationship)でスターター アプリケーションを入手できます。</span><span class="sxs-lookup"><span data-stu-id="d5514-172">You can get the starter application on our [samples repo on GitHub](https://github.com/dotnet/samples/tree/main/csharp/tutorials/default-interface-members-versions/starter/customer-relationship).</span></span>

<span data-ttu-id="d5514-173">これらの新機能は、新しいメンバーに妥当な既定の実装がある場合に、インターフェイスを安全に更新できることを意味します。</span><span class="sxs-lookup"><span data-stu-id="d5514-173">These new features mean that interfaces can be updated safely when there's a reasonable default implementation for those new members.</span></span> <span data-ttu-id="d5514-174">複数のクラスから実装できる 1 つの機能的なアイデアを表現するように、慎重にインターフェイスを設計してください。</span><span class="sxs-lookup"><span data-stu-id="d5514-174">Carefully design interfaces to express single functional ideas that can be implemented by multiple classes.</span></span> <span data-ttu-id="d5514-175">その結果、同じ機能的なアイデアに対して新しい要件が見つかったときに、そのインターフェイス定義を簡単にアップグレードできるようになります。</span><span class="sxs-lookup"><span data-stu-id="d5514-175">That makes it easier to upgrade those interface definitions when new requirements are discovered for that same functional idea.</span></span>
