---
title: '方法: カスタム トークンを作成する'
description: SecurityToken クラスを使用して WCF 内でカスタム セキュリティ トークンを作成する方法と、それをセキュリティ トークン プロバイダーおよび認証システムと統合する方法について説明します。
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- SecurityTokenParameters class
- security [WCF], creating custom tokens
- WSSecurityTokenSerializer class
- SecurityToken class
ms.assetid: 6d892973-1558-4115-a9e1-696777776125
ms.openlocfilehash: e0d80fe2433d894ef1f9e110e9090701dc305d8e
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/26/2020
ms.locfileid: "96266754"
---
# <a name="how-to-create-a-custom-token"></a><span data-ttu-id="713e2-103">方法: カスタム トークンを作成する</span><span class="sxs-lookup"><span data-stu-id="713e2-103">How to: Create a Custom Token</span></span>

<span data-ttu-id="713e2-104">ここでは、<xref:System.IdentityModel.Tokens.SecurityToken> を使用してカスタムのセキュリティ トークンを作成する方法と、作成したトークンを、カスタム セキュリティ トークン プロバイダーおよび認証システムと統合する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="713e2-104">This topic shows how to create a custom security token using the <xref:System.IdentityModel.Tokens.SecurityToken> class, and how to integrate it with a custom security token provider and authenticator.</span></span> <span data-ttu-id="713e2-105">コード例全体については、「[カスタム トークン](../samples/custom-token.md)」サンプルを参照してください。</span><span class="sxs-lookup"><span data-stu-id="713e2-105">For a complete code example see the [Custom Token](../samples/custom-token.md) sample.</span></span>  
  
 <span data-ttu-id="713e2-106">"*セキュリティ トークン*" とは、基本的に、Windows Communication Foundation (WCF) セキュリティ フレームワークが SOAP メッセージ内の送信者に関するクレームを表すために使用する XML 要素です。</span><span class="sxs-lookup"><span data-stu-id="713e2-106">A *security token* is essentially an XML element that is used by the Windows Communication Foundation (WCF) security framework to represent claims about a sender inside the SOAP message.</span></span> <span data-ttu-id="713e2-107">WCF セキュリティにより、システム指定の認証モードで使用するさまざまなトークンが提供されます。</span><span class="sxs-lookup"><span data-stu-id="713e2-107">WCF security provides various tokens for system-provided authentication modes.</span></span> <span data-ttu-id="713e2-108">たとえば、<xref:System.IdentityModel.Tokens.X509SecurityToken> クラスによって表される X.509 証明書セキュリティ トークンや、<xref:System.IdentityModel.Tokens.UserNameSecurityToken> クラスによって表されるユーザー名セキュリティ トークンなどがあります。</span><span class="sxs-lookup"><span data-stu-id="713e2-108">Examples include an X.509 certificate security token represented by the <xref:System.IdentityModel.Tokens.X509SecurityToken> class or a Username security token represented by the <xref:System.IdentityModel.Tokens.UserNameSecurityToken> class.</span></span>  
  
 <span data-ttu-id="713e2-109">認証モードや資格情報は、指定した種類のトークンではサポートされないことがあります。</span><span class="sxs-lookup"><span data-stu-id="713e2-109">Sometimes an authentication mode or credential is not supported by the provided types.</span></span> <span data-ttu-id="713e2-110">そのような場合は、SOAP メッセージ内部のカスタム資格情報の XML 表現を提供するカスタム セキュリティ トークンを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="713e2-110">In that case, it is necessary to create a custom security token to provide an XML representation of the custom credential inside the SOAP message.</span></span>  
  
 <span data-ttu-id="713e2-111">以下の手順は、カスタム セキュリティ トークンの作成方法と、これを WCF セキュリティ インフラストラクチャに統合する方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="713e2-111">The following procedures show how to create a custom security token and how to integrate it with the WCF security infrastructure.</span></span> <span data-ttu-id="713e2-112">ここでは、クライアントのクレジット カードに関する情報をサーバーに渡す際に使用するクレジット カード トークンを作成します。</span><span class="sxs-lookup"><span data-stu-id="713e2-112">This topic creates a credit card token that is used to pass information about the client's credit card to the server.</span></span>  
  
 <span data-ttu-id="713e2-113">カスタム資格情報とセキュリティ トークン マネージャーの詳細については、「[チュートリアル: カスタム クライアントおよびサービスの資格情報を作成する](walkthrough-creating-custom-client-and-service-credentials.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="713e2-113">For more information about custom credentials and security token manager, see [Walkthrough: Creating Custom Client and Service Credentials](walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
 <span data-ttu-id="713e2-114">セキュリティ トークンを表すさまざまなクラスについては、「<xref:System.IdentityModel.Tokens> 名前空間」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="713e2-114">See the <xref:System.IdentityModel.Tokens> namespace for more classes that represent security tokens.</span></span>  
  
## <a name="procedures"></a><span data-ttu-id="713e2-115">手順</span><span class="sxs-lookup"><span data-stu-id="713e2-115">Procedures</span></span>  

 <span data-ttu-id="713e2-116">クライアント アプリケーションには、セキュリティ インフラストラクチャにクレジット カード情報を指定する方法を設ける必要があります。</span><span class="sxs-lookup"><span data-stu-id="713e2-116">A client application must be provided with a way to specify credit card information for the security infrastructure.</span></span> <span data-ttu-id="713e2-117">この情報は、カスタムのクライアント資格情報クラスによりアプリケーションに提供されます。</span><span class="sxs-lookup"><span data-stu-id="713e2-117">This information is made available to the application by a custom client credentials class.</span></span> <span data-ttu-id="713e2-118">最初に、カスタム クライアント資格情報のクレジット カード情報を表すクラスを作成します。</span><span class="sxs-lookup"><span data-stu-id="713e2-118">The first step is to create a class to represent the credit card information for custom client credentials.</span></span>  
  
#### <a name="to-create-a-class-that-represents-credit-card-information-inside-client-credentials"></a><span data-ttu-id="713e2-119">クライアント資格情報内のクレジット カード情報を表すクラスを作成するには</span><span class="sxs-lookup"><span data-stu-id="713e2-119">To create a class that represents credit card information inside client credentials</span></span>  
  
1. <span data-ttu-id="713e2-120">クレジット カード情報を表す新しいクラスをアプリケーションに定義します。</span><span class="sxs-lookup"><span data-stu-id="713e2-120">Define a new class that represents the credit card information for the application.</span></span> <span data-ttu-id="713e2-121">次の例は、`CreditCardInfo` クラスを示しています。</span><span class="sxs-lookup"><span data-stu-id="713e2-121">The following example names the class `CreditCardInfo`.</span></span>  
  
2. <span data-ttu-id="713e2-122">適切なプロパティをクラスに追加し、カスタム トークンに必要な情報をアプリケーションで設定できるようにします。</span><span class="sxs-lookup"><span data-stu-id="713e2-122">Add appropriate properties to the class to allow an application set the necessary information required for the custom token.</span></span> <span data-ttu-id="713e2-123">次の例では、`CardNumber`、`CardIssuer`、および `ExpirationDate` の 3 つのプロパティをクラスに割り当てます。</span><span class="sxs-lookup"><span data-stu-id="713e2-123">In this example, the class has three properties: `CardNumber`, `CardIssuer`, and `ExpirationDate`.</span></span>  
  
     [!code-csharp[c_CustomToken#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#4)]
     [!code-vb[c_CustomToken#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#4)]  
  
 <span data-ttu-id="713e2-124">次に、カスタム セキュリティ トークンを表すクラスを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="713e2-124">Next, a class that represents the custom security token must be created.</span></span> <span data-ttu-id="713e2-125">このクラスは、セキュリティ トークン プロバイダー、認証システム、およびシリアライザーの各クラスが、WCF セキュリティ インフラストラクチャとの間で、セキュリティ トークンに関する情報を受け渡しする際に使用します。</span><span class="sxs-lookup"><span data-stu-id="713e2-125">This class is used by the security token provider, authenticator, and serializer classes to pass information about the security token to and from the WCF security infrastructure.</span></span>  
  
#### <a name="to-create-a-custom-security-token-class"></a><span data-ttu-id="713e2-126">カスタム セキュリティ トークン クラスを作成するには</span><span class="sxs-lookup"><span data-stu-id="713e2-126">To create a custom security token class</span></span>  
  
1. <span data-ttu-id="713e2-127"><xref:System.IdentityModel.Tokens.SecurityToken> クラスから派生する新しいクラスを定義します。</span><span class="sxs-lookup"><span data-stu-id="713e2-127">Define a new class derived from the <xref:System.IdentityModel.Tokens.SecurityToken> class.</span></span> <span data-ttu-id="713e2-128">`CreditCardToken` という名前のクラスを作成する例を次に示します。</span><span class="sxs-lookup"><span data-stu-id="713e2-128">This example creates a class named `CreditCardToken`.</span></span>  
  
2. <span data-ttu-id="713e2-129"><xref:System.IdentityModel.Tokens.SecurityToken.Id%2A> プロパティをオーバーライドします。</span><span class="sxs-lookup"><span data-stu-id="713e2-129">Override the <xref:System.IdentityModel.Tokens.SecurityToken.Id%2A> property.</span></span> <span data-ttu-id="713e2-130">このプロパティを使用して、SOAP メッセージ内の他の要素からセキュリティ トークンの XML 表現をポイントするためのセキュリティ トークンのローカル識別子を取得します。</span><span class="sxs-lookup"><span data-stu-id="713e2-130">This property is used to get the local identifier of the security token that is used to point to the security token XML representation from other elements inside the SOAP message.</span></span> <span data-ttu-id="713e2-131">次の例では、トークン識別子をコンストラクター パラメーターとしてこのプロパティに渡すことも、セキュリティ トークン インスタンスを作成するたびに新しいランダムな識別子を生成することもできます。</span><span class="sxs-lookup"><span data-stu-id="713e2-131">In this example, a token identifier can be either passed to it as a constructor parameter or a new random one is generated every time a security token instance is created.</span></span>  
  
3. <span data-ttu-id="713e2-132"><xref:System.IdentityModel.Tokens.SecurityToken.SecurityKeys%2A> プロパティを実装します。</span><span class="sxs-lookup"><span data-stu-id="713e2-132">Implement the <xref:System.IdentityModel.Tokens.SecurityToken.SecurityKeys%2A> property.</span></span> <span data-ttu-id="713e2-133">このプロパティは、セキュリティ トークン インスタンスが表すセキュリティ キーのコレクションを返します。</span><span class="sxs-lookup"><span data-stu-id="713e2-133">This property returns a collection of security keys that the security token instance represents.</span></span> <span data-ttu-id="713e2-134">WCF では、これらのキーを使用して、SOAP メッセージの一部に署名したり、暗号化したりできます。</span><span class="sxs-lookup"><span data-stu-id="713e2-134">Such keys can be used by WCF to sign or encrypt parts of the SOAP message.</span></span> <span data-ttu-id="713e2-135">次の例では、クレジット カード セキュリティ トークンにはセキュリティ キーを含めることができません。そのため、実装は、常に空のコレクションを返します。</span><span class="sxs-lookup"><span data-stu-id="713e2-135">In this example, the credit card security token cannot contain any security keys; therefore, the implementation always returns an empty collection.</span></span>  
  
4. <span data-ttu-id="713e2-136"><xref:System.IdentityModel.Tokens.SecurityToken.ValidFrom%2A> プロパティと <xref:System.IdentityModel.Tokens.SecurityToken.ValidTo%2A> プロパティをオーバーライドします。</span><span class="sxs-lookup"><span data-stu-id="713e2-136">Override the <xref:System.IdentityModel.Tokens.SecurityToken.ValidFrom%2A> and <xref:System.IdentityModel.Tokens.SecurityToken.ValidTo%2A> properties.</span></span> <span data-ttu-id="713e2-137">WCF では、これらのプロパティを使用して、セキュリティ トークン インスタンスの有効性を判別します。</span><span class="sxs-lookup"><span data-stu-id="713e2-137">These properties are used by WCF to determine the validity of the security token instance.</span></span> <span data-ttu-id="713e2-138">次の例では、クレジット カード セキュリティ トークンに有効期限のみが含まれているため、`ValidFrom` プロパティは、インスタンスの作成日時を表す <xref:System.DateTime> を返します。</span><span class="sxs-lookup"><span data-stu-id="713e2-138">In this example, the credit card security token has only an expiration date, so the `ValidFrom` property returns a <xref:System.DateTime> that represents the date and time of the instance creation.</span></span>  
  
     [!code-csharp[c_CustomToken#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#1)]
     [!code-vb[c_CustomToken#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#1)]  
  
 <span data-ttu-id="713e2-139">セキュリティ トークンの新しい種類を作成したときは、<xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> クラスの実装が必要です。</span><span class="sxs-lookup"><span data-stu-id="713e2-139">When a new security token type is created, it requires an implementation of the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> class.</span></span> <span data-ttu-id="713e2-140">この実装をセキュリティ バインド要素構成で使用して、新しいトークンの種類を表します。</span><span class="sxs-lookup"><span data-stu-id="713e2-140">The implementation is used in the security binding element configuration to represent the new token type.</span></span> <span data-ttu-id="713e2-141">セキュリティ トークンのパラメーター クラスは、メッセージを処理するときに実際のセキュリティ トークン インスタンスを一致させるためのテンプレートとして使用できます。</span><span class="sxs-lookup"><span data-stu-id="713e2-141">The security token parameters class serves as a template that is used to match the actual security token instance to when a message is processed.</span></span> <span data-ttu-id="713e2-142">このテンプレートは、セキュリティ トークンを使用したり、認証したりする際に適合する必要がある条件を指定するためにアプリケーションで使用できる追加のプロパティを提供します。</span><span class="sxs-lookup"><span data-stu-id="713e2-142">The template provides additional properties that an application can use to specify criteria that the security token must match to be used or authenticated.</span></span> <span data-ttu-id="713e2-143">次の例では、追加のプロパティを指定しないため、使用または検証するセキュリティ トークン インスタンスを WCF インフラストラクチャが検索するときに、該当するセキュリティ トークンの種類だけが一致項目になります。</span><span class="sxs-lookup"><span data-stu-id="713e2-143">The following example does not add any additional properties, so only the security token type is matched when the WCF infrastructure searches for a security token instance to use or to validate.</span></span>  
  
#### <a name="to-create-a-custom-security-token-parameters-class"></a><span data-ttu-id="713e2-144">カスタム セキュリティ トークン パラメーター クラスを作成するには</span><span class="sxs-lookup"><span data-stu-id="713e2-144">To create a custom security token parameters class</span></span>  
  
1. <span data-ttu-id="713e2-145"><xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> クラスから派生する新しいクラスを定義します。</span><span class="sxs-lookup"><span data-stu-id="713e2-145">Define a new class derived from the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> class.</span></span>  
  
2. <span data-ttu-id="713e2-146"><xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CloneCore%2A> メソッドを実装します。</span><span class="sxs-lookup"><span data-stu-id="713e2-146">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CloneCore%2A> method.</span></span> <span data-ttu-id="713e2-147">クラスで内部フィールドが定義されている場合は、それらをすべてコピーします。</span><span class="sxs-lookup"><span data-stu-id="713e2-147">Copy all internal fields defined in your class, if any.</span></span> <span data-ttu-id="713e2-148">次の例では、追加のフィールドを定義しません。</span><span class="sxs-lookup"><span data-stu-id="713e2-148">This example does not define any additional fields.</span></span>  
  
3. <span data-ttu-id="713e2-149"><xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientAuthentication%2A> の読み取り専用プロパティを実装します。</span><span class="sxs-lookup"><span data-stu-id="713e2-149">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientAuthentication%2A> read-only property.</span></span> <span data-ttu-id="713e2-150">このクラスで表されているセキュリティ トークンの種類を使用して、サービスに対するクライアントの認証が可能な場合、このプロパティは `true` を返します。</span><span class="sxs-lookup"><span data-stu-id="713e2-150">This property returns `true` if the security token type represented by this class can be used to authenticate a client to a service.</span></span> <span data-ttu-id="713e2-151">次の例では、クレジット カード セキュリティ トークンを使用して、サービスに対するクライアントの認証を行うことができます。</span><span class="sxs-lookup"><span data-stu-id="713e2-151">In this example, the credit card security token can be used to authenticate a client to a service.</span></span>  
  
4. <span data-ttu-id="713e2-152"><xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsServerAuthentication%2A> の読み取り専用プロパティを実装します。</span><span class="sxs-lookup"><span data-stu-id="713e2-152">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsServerAuthentication%2A> read-only property.</span></span> <span data-ttu-id="713e2-153">このクラスで表されているセキュリティ トークンの種類を使用して、クライアントに対するサービスの認証が可能な場合、このプロパティは `true` を返します。</span><span class="sxs-lookup"><span data-stu-id="713e2-153">This property returns `true` if the security token type represented by this class can be used to authenticate a service to a client.</span></span> <span data-ttu-id="713e2-154">次の例では、クレジット カード セキュリティ トークンを使用して、クライアントに対するサービスの認証を行うことができません。</span><span class="sxs-lookup"><span data-stu-id="713e2-154">In this example, the credit card security token cannot be used to authenticate a service to a client.</span></span>  
  
5. <span data-ttu-id="713e2-155"><xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientWindowsIdentity%2A> の読み取り専用プロパティを実装します。</span><span class="sxs-lookup"><span data-stu-id="713e2-155">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientWindowsIdentity%2A> read-only property.</span></span> <span data-ttu-id="713e2-156">このクラスで表されているセキュリティ トークンの種類を Windows アカウントにマップできる場合、このプロパティは `true` を返します。</span><span class="sxs-lookup"><span data-stu-id="713e2-156">This property returns `true` if the security token type represented by this class can be mapped to a Windows account.</span></span> <span data-ttu-id="713e2-157">その場合、認証結果が <xref:System.Security.Principal.WindowsIdentity> クラス インスタンスによって表されます。</span><span class="sxs-lookup"><span data-stu-id="713e2-157">If so, the authentication result is represented by a <xref:System.Security.Principal.WindowsIdentity> class instance.</span></span> <span data-ttu-id="713e2-158">次の例では、Windows アカウントにトークンをマップすることができません。</span><span class="sxs-lookup"><span data-stu-id="713e2-158">In this example, the token cannot be mapped to a Windows account.</span></span>  
  
6. <span data-ttu-id="713e2-159"><xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CreateKeyIdentifierClause%28System.IdentityModel.Tokens.SecurityToken%2CSystem.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle%29> メソッドを実装します。</span><span class="sxs-lookup"><span data-stu-id="713e2-159">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CreateKeyIdentifierClause%28System.IdentityModel.Tokens.SecurityToken%2CSystem.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle%29> method.</span></span> <span data-ttu-id="713e2-160">このメソッドは、このセキュリティ トークン パラメーター クラスによって表されるセキュリティ トークン インスタンスへの参照が必要なときに WCF セキュリティ フレームワークによって呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="713e2-160">This method is called by WCF security framework when it requires a reference to the security token instance represented by this security token parameters class.</span></span> <span data-ttu-id="713e2-161">このメソッドには、実際のセキュリティ トークン インスタンスと、要求されている参照の型を指定する <xref:System.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle> の両方が引数として渡されます。</span><span class="sxs-lookup"><span data-stu-id="713e2-161">Both the actual security token instance and <xref:System.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle> that specifies the type of the reference that is being requested are passed to this method as arguments.</span></span> <span data-ttu-id="713e2-162">次の例では、内部参照だけがクレジット カード セキュリティ トークンでサポートされます。</span><span class="sxs-lookup"><span data-stu-id="713e2-162">In this example, only internal references are supported by the credit card security token.</span></span> <span data-ttu-id="713e2-163"><xref:System.IdentityModel.Tokens.SecurityToken> クラスは、内部参照を作成する機能を備えているため、実装には追加のコードが必要ありません。</span><span class="sxs-lookup"><span data-stu-id="713e2-163">The <xref:System.IdentityModel.Tokens.SecurityToken> class has functionality to create internal references; therefore, the implementation does not require additional code.</span></span>  
  
7. <span data-ttu-id="713e2-164"><xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.InitializeSecurityTokenRequirement%28System.IdentityModel.Selectors.SecurityTokenRequirement%29> メソッドを実装します。</span><span class="sxs-lookup"><span data-stu-id="713e2-164">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.InitializeSecurityTokenRequirement%28System.IdentityModel.Selectors.SecurityTokenRequirement%29> method.</span></span> <span data-ttu-id="713e2-165">WCF では、このメソッドを呼び出して、セキュリティ トークン パラメーター クラス インスタンスを <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> クラスのインスタンスに変換します。</span><span class="sxs-lookup"><span data-stu-id="713e2-165">This method is called by WCF to convert the security token parameters class instance into an instance of the <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> class.</span></span> <span data-ttu-id="713e2-166">変換結果は、適切なセキュリティ トークン インスタンスを作成するためにセキュリティ トークン プロバイダーによって使用されます。</span><span class="sxs-lookup"><span data-stu-id="713e2-166">The result is used by security token providers to create the appropriate security token instance.</span></span>  
  
     [!code-csharp[c_CustomToken#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#2)]
     [!code-vb[c_CustomToken#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#2)]  
  
 <span data-ttu-id="713e2-167">セキュリティ トークンは、SOAP メッセージ内で送信されますが、そのためには、セキュリティ トークンのインメモリ表現とネットワーク上表現の間での変換機構が必要です。</span><span class="sxs-lookup"><span data-stu-id="713e2-167">Security tokens are transmitted inside SOAP messages, which requires a translation mechanism between the in-memory security token representation and the on-the-wire representation.</span></span> <span data-ttu-id="713e2-168">WCF では、セキュリティ トークン シリアライザーを使用してこのタスクが実行されます。</span><span class="sxs-lookup"><span data-stu-id="713e2-168">WCF uses a security token serializer to accomplish this task.</span></span> <span data-ttu-id="713e2-169">すべてのカスタム トークンには、カスタム セキュリティ トークンを SOAP メッセージからシリアル化および逆シリアル化できるカスタム セキュリティ トークン シリアライザーを関連付ける必要があります。</span><span class="sxs-lookup"><span data-stu-id="713e2-169">Every custom token must be accompanied by a custom security token serializer that can serialize and deserialize the custom security token from the SOAP message.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="713e2-170">派生キーは、既定で有効になっています。</span><span class="sxs-lookup"><span data-stu-id="713e2-170">Derived keys are enabled by default.</span></span> <span data-ttu-id="713e2-171">カスタム セキュリティ トークンを作成し、プライマリ トークンとして使用する場合、WCF では、そこからキーが派生します。</span><span class="sxs-lookup"><span data-stu-id="713e2-171">If you create a custom security token and use it as the primary token, WCF derives a key from it.</span></span> <span data-ttu-id="713e2-172">キーを派生する一方、カスタム セキュリティ トークン シリアライザーが呼び出され、<xref:System.IdentityModel.Tokens.SecurityKeyIdentifierClause> をシリアル化しながら、そのカスタム セキュリティ トークンの `DerivedKeyToken` をネットワークに送出します。</span><span class="sxs-lookup"><span data-stu-id="713e2-172">While doing so, it calls the custom security token serializer to write the <xref:System.IdentityModel.Tokens.SecurityKeyIdentifierClause> for the custom security token while serializing the `DerivedKeyToken` to the wire.</span></span> <span data-ttu-id="713e2-173">受信側では、ネットワーク外でのトークンの逆シリアル化時に、`DerivedKeyToken` シリアライザーは、トークンのすぐ下のトップレベルの子として `SecurityTokenReference` 要素を必要とします。</span><span class="sxs-lookup"><span data-stu-id="713e2-173">On the receiving end, when deserializing the token off the wire, the `DerivedKeyToken` serializer expects a `SecurityTokenReference` element as the top-level child under itself.</span></span> <span data-ttu-id="713e2-174">カスタム セキュリティ トークン シリアライザーによる句型のシリアル化時に `SecurityTokenReference` 要素が追加されていなかった場合、例外がスローされます。</span><span class="sxs-lookup"><span data-stu-id="713e2-174">If the custom security token serializer did not add a `SecurityTokenReference` element while serializing its clause type, an exception is thrown.</span></span>  
  
#### <a name="to-create-a-custom-security-token-serializer"></a><span data-ttu-id="713e2-175">カスタム セキュリティ トークン シリアライザーを作成するには</span><span class="sxs-lookup"><span data-stu-id="713e2-175">To create a custom security token serializer</span></span>  
  
1. <span data-ttu-id="713e2-176"><xref:System.ServiceModel.Security.WSSecurityTokenSerializer> クラスから派生する新しいクラスを定義します。</span><span class="sxs-lookup"><span data-stu-id="713e2-176">Define a new class derived from the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer> class.</span></span>  
  
2. <span data-ttu-id="713e2-177"><xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanReadTokenCore%28System.Xml.XmlReader%29> に基づいて XML ストリームを読み取る <xref:System.Xml.XmlReader> メソッドをオーバーライドします。</span><span class="sxs-lookup"><span data-stu-id="713e2-177">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanReadTokenCore%28System.Xml.XmlReader%29> method, which relies on an <xref:System.Xml.XmlReader> to read the XML stream.</span></span> <span data-ttu-id="713e2-178">シリアライザー実装が現在の要素に基づいてセキュリティ トークンを逆シリアル化できる場合、このメソッドは `true` を返します。</span><span class="sxs-lookup"><span data-stu-id="713e2-178">The method returns `true` if the serializer implementation can deserialize the security token based given its current element.</span></span> <span data-ttu-id="713e2-179">次の例では、このメソッドが、XML リーダーの現在の XML 要素が正しい要素名と名前空間を持っているかどうかをチェックします。</span><span class="sxs-lookup"><span data-stu-id="713e2-179">In this example, this method checks whether the XML reader's current XML element has the correct element name and namespace.</span></span> <span data-ttu-id="713e2-180">持っていない場合は、このメソッドの基本クラスの実装を呼び出して、XML 要素を処理します。</span><span class="sxs-lookup"><span data-stu-id="713e2-180">If it does not, it calls the base class implementation of this method to handle the XML element.</span></span>  
  
3. <span data-ttu-id="713e2-181"><xref:System.ServiceModel.Security.WSSecurityTokenSerializer.ReadTokenCore%28System.Xml.XmlReader%2CSystem.IdentityModel.Selectors.SecurityTokenResolver%29> メソッドをオーバーライドします。</span><span class="sxs-lookup"><span data-stu-id="713e2-181">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.ReadTokenCore%28System.Xml.XmlReader%2CSystem.IdentityModel.Selectors.SecurityTokenResolver%29> method.</span></span> <span data-ttu-id="713e2-182">このメソッドは、セキュリティ トークンの XML コンテンツを読み取り、その適切なメモリ内表現を構築します。</span><span class="sxs-lookup"><span data-stu-id="713e2-182">This method reads the XML content of the security token and constructs the appropriate in-memory representation for it.</span></span> <span data-ttu-id="713e2-183">渡された XML リーダーの基盤となる XML 要素を認識できない場合は、基本クラスの実装を呼び出して、システム指定のトークンの種類を処理します。</span><span class="sxs-lookup"><span data-stu-id="713e2-183">If it does not recognize the XML element on which the passed-in XML reader is standing, it calls the base class implementation to process the system-provided token types.</span></span>  
  
4. <span data-ttu-id="713e2-184"><xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanWriteTokenCore%28System.IdentityModel.Tokens.SecurityToken%29> メソッドをオーバーライドします。</span><span class="sxs-lookup"><span data-stu-id="713e2-184">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanWriteTokenCore%28System.IdentityModel.Tokens.SecurityToken%29> method.</span></span> <span data-ttu-id="713e2-185">引数として渡されるトークンのメモリ内表現を XML 表現に変換できる場合、このメソッドは `true` を返します。</span><span class="sxs-lookup"><span data-stu-id="713e2-185">This method returns `true` if it can convert the in-memory token representation (passed in as an argument) to the XML representation.</span></span> <span data-ttu-id="713e2-186">変換できない場合は、基本クラスの実装を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="713e2-186">If it cannot convert, it calls the base class implementation.</span></span>  
  
5. <span data-ttu-id="713e2-187"><xref:System.ServiceModel.Security.WSSecurityTokenSerializer.WriteTokenCore%28System.Xml.XmlWriter%2CSystem.IdentityModel.Tokens.SecurityToken%29> メソッドをオーバーライドします。</span><span class="sxs-lookup"><span data-stu-id="713e2-187">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.WriteTokenCore%28System.Xml.XmlWriter%2CSystem.IdentityModel.Tokens.SecurityToken%29> method.</span></span> <span data-ttu-id="713e2-188">このメソッドは、セキュリティ トークンのメモリ内表現を XML 表現に変換します。</span><span class="sxs-lookup"><span data-stu-id="713e2-188">This method converts an in-memory security token representation into an XML representation.</span></span> <span data-ttu-id="713e2-189">変換できない場合は、基本クラスの実装を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="713e2-189">If the method cannot convert, it calls the base class implementation.</span></span>  
  
     [!code-csharp[c_CustomToken#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#3)]
     [!code-vb[c_CustomToken#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#3)]  
  
 <span data-ttu-id="713e2-190">上記の 4 つの手順を完了したら、カスタム セキュリティ トークンをセキュリティ トークン プロバイダー、セキュリティ トークン認証システム、セキュリティ トークン マネージャー、クライアント資格情報、およびサービス資格情報と統合します。</span><span class="sxs-lookup"><span data-stu-id="713e2-190">After completing the four previous procedures, integrate the custom security token with the security token provider, authenticator, manager, and client and service credentials.</span></span>  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-provider"></a><span data-ttu-id="713e2-191">カスタム セキュリティ トークンをセキュリティ トークン プロバイダーと統合するには</span><span class="sxs-lookup"><span data-stu-id="713e2-191">To integrate the custom security token with a security token provider</span></span>  
  
1. <span data-ttu-id="713e2-192">セキュリティ トークン プロバイダーは、必要に応じて、トークンのインスタンスを作成、変更、および返却します。</span><span class="sxs-lookup"><span data-stu-id="713e2-192">The security token provider creates, modifies (if necessary), and returns an instance of the token.</span></span> <span data-ttu-id="713e2-193">カスタム セキュリティ トークンのカスタム プロバイダーを作成するには、<xref:System.IdentityModel.Selectors.SecurityTokenProvider> クラスを継承するクラスを作成します。</span><span class="sxs-lookup"><span data-stu-id="713e2-193">To create a custom provider for the custom security token, create a class that inherits from the <xref:System.IdentityModel.Selectors.SecurityTokenProvider> class.</span></span> <span data-ttu-id="713e2-194"><xref:System.IdentityModel.Selectors.SecurityTokenProvider.GetTokenCore%2A> メソッドをオーバーライドして、`CreditCardToken` のインスタンスを返す例を次に示します。</span><span class="sxs-lookup"><span data-stu-id="713e2-194">The following example overrides the <xref:System.IdentityModel.Selectors.SecurityTokenProvider.GetTokenCore%2A> method to return an instance of the `CreditCardToken`.</span></span> <span data-ttu-id="713e2-195">カスタム セキュリティ トークン プロバイダーの詳細については、「[方法: カスタム セキュリティ トークン プロバイダーを作成する](how-to-create-a-custom-security-token-provider.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="713e2-195">For more information about custom security token providers, see [How to: Create a Custom Security Token Provider](how-to-create-a-custom-security-token-provider.md).</span></span>  
  
     [!code-csharp[c_CustomToken#6](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#6)]
     [!code-vb[c_CustomToken#6](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#6)]  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-authenticator"></a><span data-ttu-id="713e2-196">カスタム セキュリティ トークンをセキュリティ トークン認証システムと統合するには</span><span class="sxs-lookup"><span data-stu-id="713e2-196">To integrate the custom security token with a security token authenticator</span></span>  
  
1. <span data-ttu-id="713e2-197">セキュリティ トークン認証システムは、セキュリティ トークンがメッセージから抽出されたときにトークンの内容を検証します。</span><span class="sxs-lookup"><span data-stu-id="713e2-197">The security token authenticator validates the content of the security token when it is extracted from the message.</span></span> <span data-ttu-id="713e2-198">カスタム セキュリティ トークンのカスタム認証システムを作成するには、<xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator> クラスを継承するクラスを作成します。</span><span class="sxs-lookup"><span data-stu-id="713e2-198">To create a custom authenticator for the custom security token, create a class that inherits from the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator> class.</span></span> <span data-ttu-id="713e2-199"><xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A> メソッドをオーバーライドする例を次に示します。</span><span class="sxs-lookup"><span data-stu-id="713e2-199">The following example overrides the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A> method.</span></span> <span data-ttu-id="713e2-200">カスタム セキュリティ トークン認証システムの詳細については、「[方法: カスタム セキュリティ トークン認証システムを作成する](how-to-create-a-custom-security-token-authenticator.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="713e2-200">For more information about custom security token authenticators, see [How to: Create a Custom Security Token Authenticator](how-to-create-a-custom-security-token-authenticator.md).</span></span>  
  
     [!code-csharp[c_CustomToken#7](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#7)]
     [!code-vb[c_CustomToken#7](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#7)]  
  
     [!code-csharp[c_CustomToken#12](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#12)]
     [!code-vb[c_CustomToken#12](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#12)]  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-manager"></a><span data-ttu-id="713e2-201">カスタム セキュリティ トークンをセキュリティ トークン マネージャーと統合するには</span><span class="sxs-lookup"><span data-stu-id="713e2-201">To integrate the custom security token with a security token manager</span></span>  
  
1. <span data-ttu-id="713e2-202">セキュリティ トークン マネージャーは、トークン プロバイダー、セキュリティ認証システム、およびトークン シリアライザーの適切なインスタンスを作成します。</span><span class="sxs-lookup"><span data-stu-id="713e2-202">The security token manager creates the appropriate token provider, security authenticator, and token serializer instances.</span></span> <span data-ttu-id="713e2-203">カスタム トークン マネージャーを作成するには、<xref:System.ServiceModel.ClientCredentialsSecurityTokenManager> クラスを継承するクラスを作成します。</span><span class="sxs-lookup"><span data-stu-id="713e2-203">To create a custom token manager, create a class that inherits from the <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager> class.</span></span> <span data-ttu-id="713e2-204">このクラスの主要なメソッドは <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> を使用して、適切なプロバイダーとクライアント資格情報またはサービス資格情報を作成します。</span><span class="sxs-lookup"><span data-stu-id="713e2-204">The primary methods of the class use a <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> to create the appropriate provider and client or service credentials.</span></span> <span data-ttu-id="713e2-205">カスタム セキュリティ トークン マネージャーの詳細については、「[チュートリアル: カスタム クライアントおよびサービスの資格情報を作成する](walkthrough-creating-custom-client-and-service-credentials.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="713e2-205">For more information about custom security token managers, see [Walkthrough: Creating Custom Client and Service Credentials](walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
     [!code-csharp[c_CustomToken#8](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#8)]
     [!code-vb[c_CustomToken#8](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#8)]  
  
     [!code-csharp[c_CustomToken#9](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#9)]
     [!code-vb[c_CustomToken#9](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#9)]  
  
#### <a name="to-integrate-the-custom-security-token-with-custom-client-and-service-credentials"></a><span data-ttu-id="713e2-206">カスタム セキュリティ トークンをカスタムのクライアント資格情報およびサービス資格情報と統合するには</span><span class="sxs-lookup"><span data-stu-id="713e2-206">To integrate the custom security token with custom client and service credentials</span></span>  
  
1. <span data-ttu-id="713e2-207">アプリケーションに API を提供し、事前に作成したカスタム セキュリティ トークン インフラストラクチャで、カスタム セキュリティ トークンの内容を提供および認証する際に使用するカスタム トークン情報を指定できるようにするには、カスタムのクライアント資格情報とサービス資格情報を追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="713e2-207">The custom client and service credentials must be added to provide an API for the application to allow specifying custom token information that is used by the custom security token infrastructure created previously to provide and authenticate the custom security token content.</span></span> <span data-ttu-id="713e2-208">この方法を次の例に示します。</span><span class="sxs-lookup"><span data-stu-id="713e2-208">The following samples show how this can be done.</span></span> <span data-ttu-id="713e2-209">カスタム クライアントおよびサービス椅子資格情報の詳細については、「[チュートリアル: カスタム クライアントおよびサービスの資格情報を作成する](walkthrough-creating-custom-client-and-service-credentials.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="713e2-209">For more information about custom client and service credentials, see [Walkthrough: Creating Custom Client and Service Credentials](walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
     [!code-csharp[c_CustomToken#10](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#10)]
     [!code-vb[c_CustomToken#10](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#10)]  
  
     [!code-csharp[c_customToken#11](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#11)]
     [!code-vb[c_customToken#11](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#11)]  
  
 <span data-ttu-id="713e2-210">事前に作成したカスタム セキュリティ トークン パラメーター クラスを使用して、サービスとの通信時にカスタム セキュリティ トークンを使用する必要があることを WCF セキュリティ フレームワークに伝えます。</span><span class="sxs-lookup"><span data-stu-id="713e2-210">The custom security token parameters class created previously is used to tell the WCF security framework that a custom security token must be used when communicating with a service.</span></span> <span data-ttu-id="713e2-211">この方法を次の手順に示します。</span><span class="sxs-lookup"><span data-stu-id="713e2-211">The following procedure shows how this can be done.</span></span>  
  
#### <a name="to-integrate-the-custom-security-token-with-the-binding"></a><span data-ttu-id="713e2-212">カスタム セキュリティ トークンをバインディングと統合するには</span><span class="sxs-lookup"><span data-stu-id="713e2-212">To integrate the custom security token with the binding</span></span>  
  
1. <span data-ttu-id="713e2-213"><xref:System.ServiceModel.Channels.SecurityBindingElement> クラスで公開されるトークン パラメーター コレクションの 1 つで、カスタム セキュリティ トークン パラメーター クラスを指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="713e2-213">The custom security token parameters class must be specified in one of the token parameters collections that are exposed on the <xref:System.ServiceModel.Channels.SecurityBindingElement> class.</span></span> <span data-ttu-id="713e2-214">次の例では、`SignedEncrypted` によって返されるコレクションを使用します。</span><span class="sxs-lookup"><span data-stu-id="713e2-214">The following example uses the collection returned by `SignedEncrypted`.</span></span> <span data-ttu-id="713e2-215">このコードでは、クライアントからサービスに送信されるすべてのメッセージにクレジット カードのカスタム トークンを追加し、メッセージの内容に自動的に署名して暗号化します。</span><span class="sxs-lookup"><span data-stu-id="713e2-215">The code adds the credit card custom token to every message sent from the client to the service with its content automatically signed and encrypted.</span></span>  
  
     [!code-csharp[c_CustomToken#13](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#13)]
     [!code-vb[c_CustomToken#13](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#13)]  
  
 <span data-ttu-id="713e2-216">このトピックでは、カスタム トークンを実装および使用するために必要なさまざまなコードを示します。</span><span class="sxs-lookup"><span data-stu-id="713e2-216">This topic shows the various pieces of code necessary to implement and use a custom token.</span></span> <span data-ttu-id="713e2-217">これらのコードをすべて組み合わせた完全な例については、「[カスタム トークン](../samples/custom-token.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="713e2-217">To see a complete example of how all these pieces of code fit together see, [Custom Token](../samples/custom-token.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="713e2-218">関連項目</span><span class="sxs-lookup"><span data-stu-id="713e2-218">See also</span></span>

- <xref:System.IdentityModel.Tokens.SecurityToken>
- <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters>
- <xref:System.ServiceModel.Security.WSSecurityTokenSerializer>
- <xref:System.IdentityModel.Selectors.SecurityTokenProvider>
- <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator>
- <xref:System.IdentityModel.Policy.IAuthorizationPolicy>
- <xref:System.IdentityModel.Selectors.SecurityTokenRequirement>
- <xref:System.IdentityModel.Selectors.SecurityTokenManager>
- <xref:System.ServiceModel.Description.ClientCredentials>
- <xref:System.ServiceModel.Description.ServiceCredentials>
- <xref:System.ServiceModel.Channels.SecurityBindingElement>
- [<span data-ttu-id="713e2-219">チュートリアル: カスタム クライアントおよびサービスの資格情報を作成する</span><span class="sxs-lookup"><span data-stu-id="713e2-219">Walkthrough: Creating Custom Client and Service Credentials</span></span>](walkthrough-creating-custom-client-and-service-credentials.md)
- [<span data-ttu-id="713e2-220">方法: カスタム セキュリティ トークン認証システムを作成する</span><span class="sxs-lookup"><span data-stu-id="713e2-220">How to: Create a Custom Security Token Authenticator</span></span>](how-to-create-a-custom-security-token-authenticator.md)
- [<span data-ttu-id="713e2-221">方法: カスタム セキュリティ トークン プロバイダーを作成する</span><span class="sxs-lookup"><span data-stu-id="713e2-221">How to: Create a Custom Security Token Provider</span></span>](how-to-create-a-custom-security-token-provider.md)
