---
title: 運用環境での実行中に移行するための戦略
description: 大規模なアプリをすべて一度に ASP.NET MVC から ASP.NET Core に移行することが不可能な場合もあるでしょう。 アプリを既存のユーザーのために運用環境で実行し続けながら ASP.NET Core に移行するためのいくつかの戦略について説明します。
author: ardalis
ms.date: 11/13/2020
ms.openlocfilehash: 4910984cb281139493aa5424809ba3eedab776e9
ms.sourcegitcommit: 42d436ebc2a7ee02fc1848c7742bc7d80e13fc2f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/04/2021
ms.locfileid: "102401347"
---
# <a name="strategies-for-migrating-while-running-in-production"></a><span data-ttu-id="d0f75-104">運用環境での実行中に移行するための戦略</span><span class="sxs-lookup"><span data-stu-id="d0f75-104">Strategies for migrating while running in production</span></span>

<span data-ttu-id="d0f75-105">多くのチームでは、.NET Core への移行を計画している .NET Framework アプリがありますが、アプリが非常に大規模なので移行を完了するまでにかなりの時間が必要になります。</span><span class="sxs-lookup"><span data-stu-id="d0f75-105">Many teams have .NET Framework apps they plan to migrate to .NET Core, but the app is so large that the migration requires a significant amount of time to complete.</span></span> <span data-ttu-id="d0f75-106">一つ一つ移行を実行している間、元のアプリを機能させ続ける必要があります。</span><span class="sxs-lookup"><span data-stu-id="d0f75-106">The original app needs to live on while the migration is done piece by piece.</span></span> <span data-ttu-id="d0f75-107">アプリの古いバージョンと新しいバージョンをサイドバイサイドで一緒に動作させるか、古いバージョンを何らかの方法で少なくとも中断させることなくインプレースで移行するための方法が必要になります。</span><span class="sxs-lookup"><span data-stu-id="d0f75-107">There needs to be a way for the old and new versions of the app to work together side-by-side, or for the old version to be migrated in-place, at least some of the way, without breaking it.</span></span> <span data-ttu-id="d0f75-108">チームは、これらの目標をサポートするためにさまざまな戦略を使用できます。</span><span class="sxs-lookup"><span data-stu-id="d0f75-108">Teams can employ many different strategies to support these goals.</span></span>

## <a name="refactor-the-net-framework-solution"></a><span data-ttu-id="d0f75-109">.NET Framework ソリューションをリファクターする</span><span class="sxs-lookup"><span data-stu-id="d0f75-109">Refactor the .NET Framework solution</span></span>

<span data-ttu-id="d0f75-110">.NET Framework アプリを .NET Core に移植する予定の場合は、手始めに、アプリを .NET Core でより適切に動作するようにリファクターすることをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="d0f75-110">A good place to start if you plan to port a .NET Framework app to .NET Core is to refactor it to work better with .NET Core.</span></span> <span data-ttu-id="d0f75-111">これは、個々のクラス ライブラリを .NET Standard をターゲットにするように更新し、ASP.NET MVC プロジェクトからできるだけ多くのロジックをそれらのクラス ライブラリ内に移動することを意味します。</span><span class="sxs-lookup"><span data-stu-id="d0f75-111">This means updating individual class libraries to target .NET Standard and moving as much logic out of your ASP.NET MVC projects and into these class libraries.</span></span> <span data-ttu-id="d0f75-112">.NET Standard ライブラリに含まれているコードは、.NET Framework から .NET Core に比較的簡単に移動できるはずです。</span><span class="sxs-lookup"><span data-stu-id="d0f75-112">Any code you have in .NET Standard libraries should move relatively easily from .NET Framework to .NET Core.</span></span>

<span data-ttu-id="d0f75-113">リファクタリングの際は、優れたリファクタリングの基本原則に従っていることを確認してください。</span><span class="sxs-lookup"><span data-stu-id="d0f75-113">When refactoring, make sure you're following good refactoring fundamentals.</span></span> <span data-ttu-id="d0f75-114">たとえば、リファクタリングを開始する前に、システムの動作を確認するテストを作成します。</span><span class="sxs-lookup"><span data-stu-id="d0f75-114">For example, create tests that verify what the system does before you start refactoring.</span></span> <span data-ttu-id="d0f75-115">完了したらこれらのテストを実行して、システムの動作を変更していないことを確認します。</span><span class="sxs-lookup"><span data-stu-id="d0f75-115">Run these tests when you're done to confirm you didn't change the system's behavior.</span></span> <span data-ttu-id="d0f75-116">信頼できる適切な一連の自動テストがまだない場合は、システムに特性テストを追加する必要があるかもしれません。</span><span class="sxs-lookup"><span data-stu-id="d0f75-116">You may need to add characterization tests to the system if you don't already have a good suite of automated tests you can rely on.</span></span>

## <a name="extract-front-end-assets-to-a-cdn"></a><span data-ttu-id="d0f75-117">フロントエンド アセットを CDN に抽出する</span><span class="sxs-lookup"><span data-stu-id="d0f75-117">Extract front-end assets to a CDN</span></span>

<span data-ttu-id="d0f75-118">.NET Framework アプリにスクリプト、CSS ファイル、画像などの静的アセットが数多く含まれている場合は、それらを別の CDN に移行することもできます。</span><span class="sxs-lookup"><span data-stu-id="d0f75-118">If your .NET Framework apps include a lot of static assets, like scripts, CSS files, or images, you may be able to migrate these to a separate CDN.</span></span> <span data-ttu-id="d0f75-119">その後、それらのアセットの CDN リンクを参照するように既存のアプリを更新します。</span><span class="sxs-lookup"><span data-stu-id="d0f75-119">Then, update the existing app to reference the CDN links for these assets.</span></span> <span data-ttu-id="d0f75-120">アプリを .NET Core に移植するときに、これらの静的ファイルは移行に含まれませんが、ASP.NET Core アプリ内でも引き続き CDN から参照できます。</span><span class="sxs-lookup"><span data-stu-id="d0f75-120">When you port the app to .NET Core, these static files won't be part of the migration, and you'll just continue referencing them from the CDN in the ASP.NET Core app.</span></span>

## <a name="extract-and-migrate-individual-microservices"></a><span data-ttu-id="d0f75-121">個々のマイクロサービスを抽出して移行する</span><span class="sxs-lookup"><span data-stu-id="d0f75-121">Extract and migrate individual microservices</span></span>

<span data-ttu-id="d0f75-122">大規模な .NET Framework アプリは、個別に移行できる個別のフロントエンド システムで既に構成されている場合があります。</span><span class="sxs-lookup"><span data-stu-id="d0f75-122">Large .NET Framework apps may already be comprised of separate front-end systems that can be migrated individually.</span></span> <span data-ttu-id="d0f75-123">または、既存の ASP.NET MVC アプリの一部が新しい ASP.NET Core マイクロサービスの実装に取り込まれていて、マイクロサービス アーキテクチャへの移行に適している場合もあります。</span><span class="sxs-lookup"><span data-stu-id="d0f75-123">Or they may be candidates for migration to a microservices architecture, with some pieces of existing ASP.NET MVC apps being pulled out into new ASP.NET Core microservice implementations.</span></span> <span data-ttu-id="d0f75-124">マイクロサービスの詳細については、関連の電子ブック「[.NET マイクロサービス: コンテナー化された .NET アプリケーションのアーキテクチャ](https://aka.ms/microservicesebook)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="d0f75-124">You can learn more about microservices in the associated ebook, [.NET Microservices: Architecture for Containerized .NET Applications](https://aka.ms/microservicesebook).</span></span>

<span data-ttu-id="d0f75-125">たとえば、既存のアプリに、ユーザーのサインインと登録に関連する一連の機能が含まれている場合があります。</span><span class="sxs-lookup"><span data-stu-id="d0f75-125">For example, the existing app might have a set of features it uses related to user sign-in and registration.</span></span> <span data-ttu-id="d0f75-126">これらを、ASP.NET Core を使用して構築および展開できる別のマイクロサービスに移行した後で、レガシ .NET Framework アプリに統合することができます。</span><span class="sxs-lookup"><span data-stu-id="d0f75-126">These could be migrated to a separate microservice, which could be built and deployed using ASP.NET Core and then integrated into the legacy .NET Framework app.</span></span> <span data-ttu-id="d0f75-127">次に、アプリに、個々のユーザーのショッピング カートを追跡する専用のページがいくつか含まれている場合があります。</span><span class="sxs-lookup"><span data-stu-id="d0f75-127">Next, the app might have a few pages dedicated to tracking the individual user's shopping cart.</span></span> <span data-ttu-id="d0f75-128">これらのページも、独自の別のマイクロサービスに取り込んでから、既存のアプリに再度統合することができます。</span><span class="sxs-lookup"><span data-stu-id="d0f75-128">These pages could also be pulled out into their own separate microservice and again integrated into the existing app.</span></span> <span data-ttu-id="d0f75-129">この方法では、元の .NET Framework アプリが運用環境で引き続き実行されますが、その機能のより多くが最新の .NET Core マイクロサービスから提供されるようになります。</span><span class="sxs-lookup"><span data-stu-id="d0f75-129">In this way, the original .NET Framework app continues running in production, but with more and more of its features coming from modernized .NET Core microservices.</span></span>

## <a name="deploy-multiple-versions-of-the-app-side-by-side-in-iis"></a><span data-ttu-id="d0f75-130">IIS 内でアプリの複数のバージョンをサイドバイサイドで展開する</span><span class="sxs-lookup"><span data-stu-id="d0f75-130">Deploy multiple versions of the app side-by-side in IIS</span></span>

<span data-ttu-id="d0f75-131">ホスト ヘッダーとリダイレクトの組み合わせを使用して、既存の ASP.NET MVC アプリを同じ IIS サーバー上の ASP.NET Core アプリとサイドバイサイドで実行されるように構成できます。</span><span class="sxs-lookup"><span data-stu-id="d0f75-131">Using a combination of host headers and redirects, an existing ASP.NET MVC app can be configured to run side by side with an ASP.NET Core app on the same IIS server.</span></span> <span data-ttu-id="d0f75-132">機能の一部 (個別のコントローラーなど) が ASP.NET Core に移植されると、そのルートと URL が、ASP.NET Core Web サイトまたはサブアプリケーションをターゲットにするように IIS 内でマップされます (IIS 仮想ディレクトリは ASP.NET Core アプリではサポートされていません)。</span><span class="sxs-lookup"><span data-stu-id="d0f75-132">As pieces of functionality, such as individual controllers, are ported to ASP.NET Core, their routes and URLs are mapped within IIS to target the ASP.NET Core web site or sub-application (IIS virtual directories aren't supported with ASP.NET Core apps).</span></span> <span data-ttu-id="d0f75-133">ASP.NET Core アプリは IIS サブアプリケーション (サブアプリ) としてホスティングできます。</span><span class="sxs-lookup"><span data-stu-id="d0f75-133">An ASP.NET Core app can be hosted as an IIS sub-application (sub-app).</span></span> <span data-ttu-id="d0f75-134">サブアプリのパスは、ルート アプリの URL の一部になります。</span><span class="sxs-lookup"><span data-stu-id="d0f75-134">The sub-app's path becomes part of the root app's URL.</span></span>

## <a name="apply-the-strangler-pattern"></a><span data-ttu-id="d0f75-135">ストラングラー パターンを適用する</span><span class="sxs-lookup"><span data-stu-id="d0f75-135">Apply the Strangler pattern</span></span>

<span data-ttu-id="d0f75-136">大規模な ASP.NET MVC アプリを、機能の一部を段階的に移行することで、新しい ASP.NET Core アプリに段階的に置き換えることができます。</span><span class="sxs-lookup"><span data-stu-id="d0f75-136">Large ASP.NET MVC apps can be gradually replaced with a new ASP.NET Core app by incrementally migrating pieces of functionality.</span></span> <span data-ttu-id="d0f75-137">その方法の 1 つは、[ストラングラー パターン](/azure/architecture/patterns/strangler)と呼ばれます。これは、木々に絡み付いて最終的には枯らしてしまう絞め殺しの木にちなんで名づけられました。</span><span class="sxs-lookup"><span data-stu-id="d0f75-137">One approach to this is called the [strangler pattern](/azure/architecture/patterns/strangler), named for strangler vines that strangle and eventually tear down trees.</span></span> <span data-ttu-id="d0f75-138">このアプローチでは、まず、既存のソリューションの上にファサード レイヤーを実装します。</span><span class="sxs-lookup"><span data-stu-id="d0f75-138">This approach relies on first implementing a facade layer over top of the existing solution.</span></span> <span data-ttu-id="d0f75-139">このファサードは、問題に対する新しいアプローチ、または API ゲートウェイなどの既製のソリューションを使用して構築する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d0f75-139">This facade should be built using the new approach to the problem, or an off-the-shelf solution such as an API gateway.</span></span>

<span data-ttu-id="d0f75-140">ファサードが設置されたら、その一部を新しい ASP.NET Core アプリにルーティングできます。</span><span class="sxs-lookup"><span data-stu-id="d0f75-140">Once the facade is in place, you can route part of it to a new ASP.NET Core app.</span></span> <span data-ttu-id="d0f75-141">元の .NET Framework アプリのより多くの部分を .NET Core に移植するにつれて、ファサードの機能全体のより多くの部分を新しいシステムに送信し、ファサード レイヤーを更新していきます。</span><span class="sxs-lookup"><span data-stu-id="d0f75-141">As you port more of the original .NET Framework app to .NET Core, you continue to update the facade layer accordingly, sending more of the facade's total functionality to the new system.</span></span> <span data-ttu-id="d0f75-142">図 3-5 に、時間の経過に伴うストラングラー パターンの進行を示します。</span><span class="sxs-lookup"><span data-stu-id="d0f75-142">Figure 3-5 shows the strangler pattern progression over time.</span></span>

## <a name="multi-targeting-approaches"></a><span data-ttu-id="d0f75-143">マルチ ターゲットによるアプローチ</span><span class="sxs-lookup"><span data-stu-id="d0f75-143">Multi-targeting approaches</span></span>

<span data-ttu-id="d0f75-144">マルチターゲットとフレームワークごとの個別のコード パスを使用することで、.NET Framework をターゲットとする大規模なアプリを時間をかけて ASP.NET Core に移行することができます。</span><span class="sxs-lookup"><span data-stu-id="d0f75-144">Large apps that target .NET Framework may be migrated to ASP.NET Core over time by using multi-targeting and separate code paths for each framework.</span></span> <span data-ttu-id="d0f75-145">たとえば、両方の環境で実行される必要があるコードを、.NET Framework での実行時と .NET Core での実行時とで異なる機能を実装したり異なる依存関係を使用したりするように、[プリプロセッサ ディレクティブ `#if`](../../csharp/language-reference/preprocessor-directives/preprocessor-if.md) を使用して変更できます。</span><span class="sxs-lookup"><span data-stu-id="d0f75-145">For example, code that must run in both environments could be modified with [preprocessor `#if`](../../csharp/language-reference/preprocessor-directives/preprocessor-if.md) directives to implement different functionality or use different dependencies when run in .NET Framework versus .NET Core.</span></span> <span data-ttu-id="d0f75-146">別の方法として、ターゲットとなっているフレームワークに基づいて異なるファイル セットを含むようにプロジェクト ファイルを変更することもできます。</span><span class="sxs-lookup"><span data-stu-id="d0f75-146">Another option is to modify project files to include different sets of files based on which framework is being targeted.</span></span> <span data-ttu-id="d0f75-147">プロジェクト ファイルはさまざまな glob パターン (`*.core.cs` など) を使用して、ターゲットとなっているフレームワークに応じて異なるソース ファイルのセットを含むことができます。</span><span class="sxs-lookup"><span data-stu-id="d0f75-147">Project files can use different globbing patterns, such as `*.core.cs`, to include different sets of source files depending on the framework being targeted.</span></span>

<span data-ttu-id="d0f75-148">これらの手法により、新しい機能が追加されてアプリ (の一部) が.NET Core を使用するように移植されるときに、1 つの共通のコードベースを保守するだけで済みます。</span><span class="sxs-lookup"><span data-stu-id="d0f75-148">These techniques allow a single common codebase to be maintained while new functionality is added and (parts of) the app are ported to use .NET Core.</span></span>

![図 3-5](media/Figure3-5.png)

<span data-ttu-id="d0f75-150">**図 3-5**</span><span class="sxs-lookup"><span data-stu-id="d0f75-150">**Figure 3-5.**</span></span> <span data-ttu-id="d0f75-151">時間の経過に伴うストラングラー パターン。</span><span class="sxs-lookup"><span data-stu-id="d0f75-151">The Strangler pattern over time.</span></span>

<span data-ttu-id="d0f75-152">最終的には、ファサード レイヤー全体が新しいモダンな実装に対応します。</span><span class="sxs-lookup"><span data-stu-id="d0f75-152">Eventually, the entire facade layer corresponds to the new, modern implementation.</span></span> <span data-ttu-id="d0f75-153">この時点で、レガシ システムとファサード レイヤーの両方を廃止できます。</span><span class="sxs-lookup"><span data-stu-id="d0f75-153">At this point, both the legacy system and the face layer can be retired.</span></span>

## <a name="summary"></a><span data-ttu-id="d0f75-154">まとめ</span><span class="sxs-lookup"><span data-stu-id="d0f75-154">Summary</span></span>

<span data-ttu-id="d0f75-155">多くの場合、大規模な ASP.NET MVC および Web API アプリはすべて一度に ASP.NET Core に移植されるのではなく、時間をかけて段階的に移行されます。</span><span class="sxs-lookup"><span data-stu-id="d0f75-155">Frequently, large ASP.NET MVC and Web API apps won't be ported to ASP.NET Core all at once, but will migrate incrementally over time.</span></span> <span data-ttu-id="d0f75-156">このセクションでは、この段階的な移行を実行するためのいくつかの戦略について説明しました。</span><span class="sxs-lookup"><span data-stu-id="d0f75-156">This section offers several strategies for performing this incremental migration.</span></span> <span data-ttu-id="d0f75-157">ご自分の組織とアプリに最適なものを選択してください。</span><span class="sxs-lookup"><span data-stu-id="d0f75-157">Choose the one(s) that will work best for your organization and app.</span></span>

## <a name="references"></a><span data-ttu-id="d0f75-158">リファレンス</span><span class="sxs-lookup"><span data-stu-id="d0f75-158">References</span></span>

- [<span data-ttu-id="d0f75-159">.NET マイクロサービス: コンテナー化された .NET アプリケーションのアーキテクチャ</span><span class="sxs-lookup"><span data-stu-id="d0f75-159">.NET Microservices: Architecture for Containerized .NET Applications</span></span>](https://aka.ms/microservicesebook)
- [<span data-ttu-id="d0f75-160">eShopOnContainers 参照マイクロサービス アプリケーション</span><span class="sxs-lookup"><span data-stu-id="d0f75-160">eShopOnContainers Reference Microservices Application</span></span>](https://github.com/dotnet-architecture/eShopOnContainers)
- [<span data-ttu-id="d0f75-161">IIS を使用した Windows での ASP.NET Core のホスト</span><span class="sxs-lookup"><span data-stu-id="d0f75-161">Host ASP.NET Core on Windows with IIS</span></span>](/aspnet/core/host-and-deploy/iis/)
- [<span data-ttu-id="d0f75-162">ストラングラー パターン</span><span class="sxs-lookup"><span data-stu-id="d0f75-162">Strangler pattern</span></span>](/azure/architecture/patterns/strangler)

>[!div class="step-by-step"]
><span data-ttu-id="d0f75-163">[前へ](understand-update-dependencies.md)
>[次へ](example-migration-eshop.md)</span><span class="sxs-lookup"><span data-stu-id="d0f75-163">[Previous](understand-update-dependencies.md)
[Next](example-migration-eshop.md)</span></span>
