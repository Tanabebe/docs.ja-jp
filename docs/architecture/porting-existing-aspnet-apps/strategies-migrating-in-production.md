---
title: 運用環境での実行中に移行するための戦略
description: ASP.NET MVC から MVC ASP.NET Core に大規模なアプリを一度に移行することはできない場合があります。 既存のユーザーに対してアプリケーションを実行し、運用環境に維持しながら、ASP.NET Core にアプリを移行する方法について説明します。
author: ardalis
ms.date: 11/13/2020
ms.openlocfilehash: 4910984cb281139493aa5424809ba3eedab776e9
ms.sourcegitcommit: 42d436ebc2a7ee02fc1848c7742bc7d80e13fc2f
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/04/2021
ms.locfileid: "102401347"
---
# <a name="strategies-for-migrating-while-running-in-production"></a><span data-ttu-id="0fa58-104">運用環境での実行中に移行するための戦略</span><span class="sxs-lookup"><span data-stu-id="0fa58-104">Strategies for migrating while running in production</span></span>

<span data-ttu-id="0fa58-105">多くのチームは .NET Core への移行を計画している .NET Framework アプリを持っていますが、このアプリは非常に大きいため、移行には長時間かかることがあります。</span><span class="sxs-lookup"><span data-stu-id="0fa58-105">Many teams have .NET Framework apps they plan to migrate to .NET Core, but the app is so large that the migration requires a significant amount of time to complete.</span></span> <span data-ttu-id="0fa58-106">移行が1つずつ行われている間、元のアプリはライブで実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0fa58-106">The original app needs to live on while the migration is done piece by piece.</span></span> <span data-ttu-id="0fa58-107">古いバージョンと新しいバージョンのアプリを並行して動作させるためには、古いバージョンを使用する必要があります。また、以前のバージョンは、少なくとも一部の方法では中断せずにインプレースで移行します。</span><span class="sxs-lookup"><span data-stu-id="0fa58-107">There needs to be a way for the old and new versions of the app to work together side-by-side, or for the old version to be migrated in-place, at least some of the way, without breaking it.</span></span> <span data-ttu-id="0fa58-108">チームは、これらの目標をサポートするためにさまざまな戦略を採用できます。</span><span class="sxs-lookup"><span data-stu-id="0fa58-108">Teams can employ many different strategies to support these goals.</span></span>

## <a name="refactor-the-net-framework-solution"></a><span data-ttu-id="0fa58-109">.NET Framework ソリューションをリファクターする</span><span class="sxs-lookup"><span data-stu-id="0fa58-109">Refactor the .NET Framework solution</span></span>

<span data-ttu-id="0fa58-110">.NET Framework アプリを .NET Core に移植する予定の場合は、.NET Core で動作するようにリファクタリングすることをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="0fa58-110">A good place to start if you plan to port a .NET Framework app to .NET Core is to refactor it to work better with .NET Core.</span></span> <span data-ttu-id="0fa58-111">これは、個々のクラスライブラリを .NET Standard ターゲットに更新し、ASP.NET MVC プロジェクトからこれらのクラスライブラリに対して、より多くのロジックを移行することを意味します。</span><span class="sxs-lookup"><span data-stu-id="0fa58-111">This means updating individual class libraries to target .NET Standard and moving as much logic out of your ASP.NET MVC projects and into these class libraries.</span></span> <span data-ttu-id="0fa58-112">.NET Standard ライブラリにあるコードは、.NET Framework から .NET Core に比較的簡単に移行できます。</span><span class="sxs-lookup"><span data-stu-id="0fa58-112">Any code you have in .NET Standard libraries should move relatively easily from .NET Framework to .NET Core.</span></span>

<span data-ttu-id="0fa58-113">リファクタリングを行うときは、適切なリファクタリングの基礎に従うようにしてください。</span><span class="sxs-lookup"><span data-stu-id="0fa58-113">When refactoring, make sure you're following good refactoring fundamentals.</span></span> <span data-ttu-id="0fa58-114">たとえば、リファクタリングを開始する前にシステムの動作を確認するテストを作成します。</span><span class="sxs-lookup"><span data-stu-id="0fa58-114">For example, create tests that verify what the system does before you start refactoring.</span></span> <span data-ttu-id="0fa58-115">システムの動作が変更されていないことを確認したら、これらのテストを実行します。</span><span class="sxs-lookup"><span data-stu-id="0fa58-115">Run these tests when you're done to confirm you didn't change the system's behavior.</span></span> <span data-ttu-id="0fa58-116">利用できる自動テストの適切なスイートがまだない場合は、システムに特性テストを追加することが必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="0fa58-116">You may need to add characterization tests to the system if you don't already have a good suite of automated tests you can rely on.</span></span>

## <a name="extract-front-end-assets-to-a-cdn"></a><span data-ttu-id="0fa58-117">CDN へのフロントエンドアセットの抽出</span><span class="sxs-lookup"><span data-stu-id="0fa58-117">Extract front-end assets to a CDN</span></span>

<span data-ttu-id="0fa58-118">.NET Framework アプリにスクリプト、CSS ファイル、イメージなどの多数の静的資産が含まれている場合は、それらを別の CDN に移行できる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="0fa58-118">If your .NET Framework apps include a lot of static assets, like scripts, CSS files, or images, you may be able to migrate these to a separate CDN.</span></span> <span data-ttu-id="0fa58-119">次に、既存のアプリを更新して、これらの資産の CDN リンクを参照します。</span><span class="sxs-lookup"><span data-stu-id="0fa58-119">Then, update the existing app to reference the CDN links for these assets.</span></span> <span data-ttu-id="0fa58-120">アプリケーションを .NET Core に移植すると、これらの静的ファイルは移行の一部にはならず、引き続き ASP.NET Core アプリの CDN からそれらのファイルを参照することになります。</span><span class="sxs-lookup"><span data-stu-id="0fa58-120">When you port the app to .NET Core, these static files won't be part of the migration, and you'll just continue referencing them from the CDN in the ASP.NET Core app.</span></span>

## <a name="extract-and-migrate-individual-microservices"></a><span data-ttu-id="0fa58-121">個々のマイクロサービスを抽出して移行する</span><span class="sxs-lookup"><span data-stu-id="0fa58-121">Extract and migrate individual microservices</span></span>

<span data-ttu-id="0fa58-122">大規模な .NET Framework アプリは、個別に移行できる個別のフロントエンドシステムで既に構成されている場合があります。</span><span class="sxs-lookup"><span data-stu-id="0fa58-122">Large .NET Framework apps may already be comprised of separate front-end systems that can be migrated individually.</span></span> <span data-ttu-id="0fa58-123">または、マイクロサービスアーキテクチャへの移行の候補である場合もあります。既存の ASP.NET MVC アプリの一部は、新しい ASP.NET Core マイクロサービスの実装に取り込まれます。</span><span class="sxs-lookup"><span data-stu-id="0fa58-123">Or they may be candidates for migration to a microservices architecture, with some pieces of existing ASP.NET MVC apps being pulled out into new ASP.NET Core microservice implementations.</span></span> <span data-ttu-id="0fa58-124">マイクロサービスの詳細については、関連付けられている電子ブック「 [.Net マイクロサービス: コンテナー化された .Net アプリケーションのアーキテクチャ](https://aka.ms/microservicesebook)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0fa58-124">You can learn more about microservices in the associated ebook, [.NET Microservices: Architecture for Containerized .NET Applications](https://aka.ms/microservicesebook).</span></span>

<span data-ttu-id="0fa58-125">たとえば、既存のアプリには、ユーザーのサインインと登録に関連する一連の機能が含まれている場合があります。</span><span class="sxs-lookup"><span data-stu-id="0fa58-125">For example, the existing app might have a set of features it uses related to user sign-in and registration.</span></span> <span data-ttu-id="0fa58-126">これらは別のマイクロサービスに移行することができます。これは、ASP.NET Core を使用して構築およびデプロイし、従来の .NET Framework アプリに統合することができます。</span><span class="sxs-lookup"><span data-stu-id="0fa58-126">These could be migrated to a separate microservice, which could be built and deployed using ASP.NET Core and then integrated into the legacy .NET Framework app.</span></span> <span data-ttu-id="0fa58-127">次に、アプリには、個々のユーザーのショッピングカートの追跡専用のページがいくつか含まれている場合があります。</span><span class="sxs-lookup"><span data-stu-id="0fa58-127">Next, the app might have a few pages dedicated to tracking the individual user's shopping cart.</span></span> <span data-ttu-id="0fa58-128">これらのページは、独自の個別のマイクロサービスに取り込まれ、既存のアプリにも統合される可能性があります。</span><span class="sxs-lookup"><span data-stu-id="0fa58-128">These pages could also be pulled out into their own separate microservice and again integrated into the existing app.</span></span> <span data-ttu-id="0fa58-129">この方法では、元の .NET Framework アプリは運用環境で実行されますが、最新の .NET Core マイクロサービスからの多くの機能が含まれます。</span><span class="sxs-lookup"><span data-stu-id="0fa58-129">In this way, the original .NET Framework app continues running in production, but with more and more of its features coming from modernized .NET Core microservices.</span></span>

## <a name="deploy-multiple-versions-of-the-app-side-by-side-in-iis"></a><span data-ttu-id="0fa58-130">IIS で複数のバージョンのアプリをサイドバイサイドで展開する</span><span class="sxs-lookup"><span data-stu-id="0fa58-130">Deploy multiple versions of the app side-by-side in IIS</span></span>

<span data-ttu-id="0fa58-131">ホストヘッダーとリダイレクトの組み合わせを使用して、既存の ASP.NET MVC アプリを同じ IIS サーバー上の ASP.NET Core アプリとサイドバイサイドで実行するように構成することができます。</span><span class="sxs-lookup"><span data-stu-id="0fa58-131">Using a combination of host headers and redirects, an existing ASP.NET MVC app can be configured to run side by side with an ASP.NET Core app on the same IIS server.</span></span> <span data-ttu-id="0fa58-132">個々のコントローラーなどの機能の一部が ASP.NET Core に移植されると、そのルートと Url は、ASP.NET Core web サイトまたはサブアプリケーションを対象とするように IIS 内でマップされます (IIS 仮想ディレクトリは ASP.NET Core アプリではサポートされません)。</span><span class="sxs-lookup"><span data-stu-id="0fa58-132">As pieces of functionality, such as individual controllers, are ported to ASP.NET Core, their routes and URLs are mapped within IIS to target the ASP.NET Core web site or sub-application (IIS virtual directories aren't supported with ASP.NET Core apps).</span></span> <span data-ttu-id="0fa58-133">ASP.NET Core アプリは IIS サブアプリケーション (サブアプリ) としてホスティングできます。</span><span class="sxs-lookup"><span data-stu-id="0fa58-133">An ASP.NET Core app can be hosted as an IIS sub-application (sub-app).</span></span> <span data-ttu-id="0fa58-134">サブアプリのパスは、ルート アプリの URL の一部になります。</span><span class="sxs-lookup"><span data-stu-id="0fa58-134">The sub-app's path becomes part of the root app's URL.</span></span>

## <a name="apply-the-strangler-pattern"></a><span data-ttu-id="0fa58-135">ストラングラーパターンを適用する</span><span class="sxs-lookup"><span data-stu-id="0fa58-135">Apply the Strangler pattern</span></span>

<span data-ttu-id="0fa58-136">大規模な ASP.NET MVC アプリは、機能の一部を段階的に移行することにより、新しい ASP.NET Core アプリに段階的に置き換えることができます。</span><span class="sxs-lookup"><span data-stu-id="0fa58-136">Large ASP.NET MVC apps can be gradually replaced with a new ASP.NET Core app by incrementally migrating pieces of functionality.</span></span> <span data-ttu-id="0fa58-137">この方法の1つとして、 [ストラングラーパターン](/azure/architecture/patterns/strangler)という名前が付けられています。ストラングラー vines は strangle で、最終的にツリーを破棄します。</span><span class="sxs-lookup"><span data-stu-id="0fa58-137">One approach to this is called the [strangler pattern](/azure/architecture/patterns/strangler), named for strangler vines that strangle and eventually tear down trees.</span></span> <span data-ttu-id="0fa58-138">この方法は、最初に既存のソリューションの上にファサード層を実装することに依存します。</span><span class="sxs-lookup"><span data-stu-id="0fa58-138">This approach relies on first implementing a facade layer over top of the existing solution.</span></span> <span data-ttu-id="0fa58-139">このファサードは、問題に対する新しいアプローチ、または API ゲートウェイなどの既製のソリューションを使用して構築する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0fa58-139">This facade should be built using the new approach to the problem, or an off-the-shelf solution such as an API gateway.</span></span>

<span data-ttu-id="0fa58-140">ファサードが配置されたら、その一部を新しい ASP.NET Core アプリにルーティングできます。</span><span class="sxs-lookup"><span data-stu-id="0fa58-140">Once the facade is in place, you can route part of it to a new ASP.NET Core app.</span></span> <span data-ttu-id="0fa58-141">元の .NET Framework アプリの数を .NET Core に移植するときは、それに応じてファサード層を更新して、façade's の合計機能を新しいシステムに送信します。</span><span class="sxs-lookup"><span data-stu-id="0fa58-141">As you port more of the original .NET Framework app to .NET Core, you continue to update the facade layer accordingly, sending more of the facade's total functionality to the new system.</span></span> <span data-ttu-id="0fa58-142">図3-5 は、時間の経過に伴うストラングラーパターンの進行を示しています。</span><span class="sxs-lookup"><span data-stu-id="0fa58-142">Figure 3-5 shows the strangler pattern progression over time.</span></span>

## <a name="multi-targeting-approaches"></a><span data-ttu-id="0fa58-143">複数のターゲットを設定する方法</span><span class="sxs-lookup"><span data-stu-id="0fa58-143">Multi-targeting approaches</span></span>

<span data-ttu-id="0fa58-144">.NET Framework を対象とする大規模なアプリは、複数のターゲットを使用し、各フレームワークに個別のコードパスを使用することによって、ASP.NET Core に移行できます。</span><span class="sxs-lookup"><span data-stu-id="0fa58-144">Large apps that target .NET Framework may be migrated to ASP.NET Core over time by using multi-targeting and separate code paths for each framework.</span></span> <span data-ttu-id="0fa58-145">たとえば、両方の環境で実行する必要があるコードは、異なる機能を実装するために[プリプロセッサ `#if` ](../../csharp/language-reference/preprocessor-directives/preprocessor-if.md)ディレクティブを使用して変更することも、.net Core .NET Framework で実行する場合は異なる依存関係を使用することもできます。</span><span class="sxs-lookup"><span data-stu-id="0fa58-145">For example, code that must run in both environments could be modified with [preprocessor `#if`](../../csharp/language-reference/preprocessor-directives/preprocessor-if.md) directives to implement different functionality or use different dependencies when run in .NET Framework versus .NET Core.</span></span> <span data-ttu-id="0fa58-146">別の方法として、プロジェクトファイルを変更して、対象となるフレームワークに基づいて異なるファイルセットを含めることもできます。</span><span class="sxs-lookup"><span data-stu-id="0fa58-146">Another option is to modify project files to include different sets of files based on which framework is being targeted.</span></span> <span data-ttu-id="0fa58-147">プロジェクトファイル `*.core.cs` では、対象となるフレームワークに応じて、さまざまなグロビングパターン (など) を使用して、さまざまなソースファイルセットを含めることができます。</span><span class="sxs-lookup"><span data-stu-id="0fa58-147">Project files can use different globbing patterns, such as `*.core.cs`, to include different sets of source files depending on the framework being targeted.</span></span>

<span data-ttu-id="0fa58-148">これらの手法によって、新しい機能が追加されたときに1つの共通コードベースを保持し、.NET Core を使用するようにアプリを移植することができます。</span><span class="sxs-lookup"><span data-stu-id="0fa58-148">These techniques allow a single common codebase to be maintained while new functionality is added and (parts of) the app are ported to use .NET Core.</span></span>

![図3-5](media/Figure3-5.png)

<span data-ttu-id="0fa58-150">**図 3-5.**</span><span class="sxs-lookup"><span data-stu-id="0fa58-150">**Figure 3-5.**</span></span> <span data-ttu-id="0fa58-151">時間の経過に伴うストラングラーパターン。</span><span class="sxs-lookup"><span data-stu-id="0fa58-151">The Strangler pattern over time.</span></span>

<span data-ttu-id="0fa58-152">最終的には、ファサード層全体が、新しい先進の実装に対応します。</span><span class="sxs-lookup"><span data-stu-id="0fa58-152">Eventually, the entire facade layer corresponds to the new, modern implementation.</span></span> <span data-ttu-id="0fa58-153">この時点で、レガシシステムと face レイヤーの両方を廃止できます。</span><span class="sxs-lookup"><span data-stu-id="0fa58-153">At this point, both the legacy system and the face layer can be retired.</span></span>

## <a name="summary"></a><span data-ttu-id="0fa58-154">まとめ</span><span class="sxs-lookup"><span data-stu-id="0fa58-154">Summary</span></span>

<span data-ttu-id="0fa58-155">多くの場合、大規模な ASP.NET MVC と Web API アプリは、一度に ASP.NET Core に移植されることはありませんが、時間の経過と共に段階的に移行されます。</span><span class="sxs-lookup"><span data-stu-id="0fa58-155">Frequently, large ASP.NET MVC and Web API apps won't be ported to ASP.NET Core all at once, but will migrate incrementally over time.</span></span> <span data-ttu-id="0fa58-156">このセクションでは、この増分移行を実行するためのいくつかの方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="0fa58-156">This section offers several strategies for performing this incremental migration.</span></span> <span data-ttu-id="0fa58-157">組織とアプリに最適なものを1つ選択します。</span><span class="sxs-lookup"><span data-stu-id="0fa58-157">Choose the one(s) that will work best for your organization and app.</span></span>

## <a name="references"></a><span data-ttu-id="0fa58-158">関連項目</span><span class="sxs-lookup"><span data-stu-id="0fa58-158">References</span></span>

- [<span data-ttu-id="0fa58-159">.NET マイクロサービス: コンテナー化された .NET アプリケーションのアーキテクチャ</span><span class="sxs-lookup"><span data-stu-id="0fa58-159">.NET Microservices: Architecture for Containerized .NET Applications</span></span>](https://aka.ms/microservicesebook)
- [<span data-ttu-id="0fa58-160">eShopOnContainers リファレンスマイクロサービスアプリケーション</span><span class="sxs-lookup"><span data-stu-id="0fa58-160">eShopOnContainers Reference Microservices Application</span></span>](https://github.com/dotnet-architecture/eShopOnContainers)
- [<span data-ttu-id="0fa58-161">IIS を使用した Windows での ASP.NET Core のホスト</span><span class="sxs-lookup"><span data-stu-id="0fa58-161">Host ASP.NET Core on Windows with IIS</span></span>](/aspnet/core/host-and-deploy/iis/)
- [<span data-ttu-id="0fa58-162">ストラングラー パターン</span><span class="sxs-lookup"><span data-stu-id="0fa58-162">Strangler pattern</span></span>](/azure/architecture/patterns/strangler)

>[!div class="step-by-step"]
><span data-ttu-id="0fa58-163">[前へ](understand-update-dependencies.md)
>[次へ](example-migration-eshop.md)</span><span class="sxs-lookup"><span data-stu-id="0fa58-163">[Previous](understand-update-dependencies.md)
[Next](example-migration-eshop.md)</span></span>
